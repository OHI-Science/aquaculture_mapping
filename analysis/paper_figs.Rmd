---
title: "Figures for paper"
author: "Gage Clawson (UCSB, NCEAS, OHI)"
date: "05/10/2021"
output: html_document
editor_options: 
  chunk_output_type: console
---

This script takes our final farms dataset and creates the figures which will be showcased in the main manuscript. 

```{r}

library(here)
library(dplyr)
library(sf)
library(raster)
library(mapview)
library(tidyverse)
library(RCurl)
library("rnaturalearth")
library("rnaturalearthdata")
library(cowplot) 
library(ggpubr)
library(RColorBrewer)
library(OpenStreetMap)
library(ggspatial)
library(ggplot2)
library(patchwork)
library(rfishbase)


source(here("_spatial/template_raster.R"))

path <- "/home/shares/food-systems/Food_footprint/_raw_data/Aquaculture_locations"

```

# Global regions

```{r}

# this file includes ocean regions:
gadm <- raster("/home/shares/food-systems/Food_footprint/_raw_data/Country_regions/gadm36mol_pyfill_10km.tif")

gadm_latlon <- raster::projectRaster(gadm, food_raster, method="ngb", over=TRUE)
# plot(gadm_latlon)

gadm_codes <- read.csv("/home/shares/food-systems/Food_footprint/_raw_data/Country_regions/gadm_reg_codes.csv") %>% 
  mutate(reg_id = as.numeric(reg_id))
```

# Read in farms data and convert to sf

```{r}
all_farms_sf <- read_csv("data/all_marine_aquaculture_farms_sources_final.csv") %>%
    st_as_sf(., 
           coords = c("X", "Y"),
           crs = crs(food_raster), 
           agr = "constant")  

all_farms <- all_farms_sf %>%
  st_drop_geometry() 

test <- all_farms_sf %>%
  filter(country == "United States of America")
mapview(test, zcol = "data_type") 

test <- all_farms_sf %>%
  filter(iso3c == "HRV")
mapview(test, zcol = "data_type") ## one weird MFG from ASC

test <- all_farms_sf %>%
  filter(iso3c == "AUS")
mapview(test, zcol = "data_type") ## one weird MFG from ASC.. i think these are fine. Justifiable since it is from the ASC...


test <- all_farms_sf %>%
  filter(data_type_2 %in% c("A", "B", "C"))
sum(test$tonnes_per_farm)

3568135/sum(all_farms_sf$tonnes_per_farm) # 0.1203892

4963244/sum(all_farms_sf$tonnes_per_farm) # 0.1674603

```



```{r}

all_farms <- read_csv("data/all_marine_aquaculture_farms_sources_final.csv") %>% 
  mutate(data_type_plot = case_when(
    data_type == "modeled locations, known number of farms" ~ "Modeled locations, known number of farms",
    data_type == "modeled locations, estimated number of farms" ~ "Modeled locations, estimated number of farms", 
    data_type == "known locations" ~ "Known locations"
  ))

unique(sort(all_farms$country))

all_farms_stat <- all_farms %>%
  mutate(lon = round(X, 0), 
         lat = round(Y, 0)) 

lon_stat <- all_farms_stat %>%
  group_by(lon) %>%
  summarise(n())

lat_stat <- all_farms_stat %>%
  group_by(lat) %>%
  summarise(n())


test <- all_farms %>%
  group_by(data_type) %>%
  summarise(n_farms = n())
```


## Make the global map (Figure 1)
```{r}
world <- ne_countries(scale = "medium", returnclass = "sf")
class(world)

# https://stackoverflow.com/questions/8545035/scatterplot-with-marginal-histograms-in-ggplot2

## This one works!

## create first plot
total_map <- ggplot(data = world) +
  geom_sf(fill = "white", lwd = 0.1) + 
  geom_point(data = all_farms, aes(x = X, y = Y, col = data_type), size = 0.1, alpha = 0.7) +
  coord_sf(xlim = c(-180, 180), ylim = c(-58, 73), expand = FALSE) +
  scale_x_continuous(breaks = c(-180, -135, -90, -45, 0, 45, 90, 135, 180), position = "top") +
  scale_y_continuous(breaks = c(-90, -45, 0, 45, 90)) + 
  theme_bw() + 
  theme(axis.title.x = element_blank(),
          axis.title.y = element_blank(),
        legend.position = "bottom", 
        legend.title=element_blank(),
        text=element_text(family="Times New Roman")) +
  guides(color = guide_legend(override.aes = list(size = 3, alpha = 0.9), nrow=2 )) +
  scale_color_manual(values = c("forestgreen", "orange1", "red3"), 
                    breaks = c("known locations", "modeled locations, known number of farms", "modeled locations, estimated number of farms"), labels = c("Known locations \n N = 16,138", "Modeled locations, known number of farms \n N = 9,951", "Modeled locations, estimated number of farms \n N = 69,354"))

total_map


# Create marginal plots
# Use geom_density/histogram for whatever you plotted on x/y axis 
plot_x <- axis_canvas(total_map, axis = "x") +
  geom_histogram(data = all_farms, aes(X, fill = data_type), bins = 360)  +
  coord_sf(xlim = c(-180, 180), expand = FALSE) +
  scale_fill_manual(values = c("forestgreen", "orange1", "red3"), 
                    breaks = c("known locations", "modeled locations, known number of farms", "modeled locations, estimated number of farms"))
plot_x

plot_y <- axis_canvas(total_map, axis = "y") +
  geom_histogram(data = all_farms, aes(y = Y, fill = data_type), bins = 180, orientation = "y") +
 #  geom_hline(yintercept = 0) + #  check to make sure it lines up
  coord_sf(ylim = c(-58, 73), expand = FALSE) + 
  scale_fill_manual(values = c("forestgreen", "orange1", "red3"), 
                    breaks = c("known locations", "modeled locations, known number of farms", "modeled locations, estimated number of farms"))

plot_y

# Combine all plots into one
plot_final <- insert_xaxis_grob(total_map, plot_x, position = "top")
plot_final <- insert_yaxis_grob(plot_final, plot_y, position = "right") 
ggdraw(plot_final)
ggsave("analysis/figs/map_fig_final.jpg", units = "in", width = 8.07, height = 5.34)

```

## Make finer resolution maps (Figure 2)
```{r}
library(dplyr)
library(sf)
library(raster)
library(mapview)
library(tidyverse)
library(ggpubr)
library(RColorBrewer)
library(ggspatial)
library(ggplot2)
library(patchwork)


## zoomed maps

chl_zoom <- ggplot(all_farms, aes(X,Y, col = data_type_plot)) +
  annotation_map_tile(type = "osm", zoomin = 0) + 
  geom_spatial_point(size = 1.25, alpha = 0.7) + 
  scale_color_manual(values = c("forestgreen", "orange1", "red3"), 
                    breaks = c("Known locations", "Modeled locations, known number of farms", "Modeled locations, estimated number of farms")) +
  coord_sf(crs = 4326, xlim = c(-75, -72.25), ylim = c(-46, -44), expand = FALSE) + # - really good
  theme(legend.position = "bottom", ## put legend on bottom
        legend.title=element_blank(), 
        axis.title.x = element_blank(), 
        axis.title.y = element_blank(),
        legend.key = element_rect(fill = NA),
        axis.text.x = element_text(angle = 60, hjust = 1),
        text=element_text(family="Times New Roman"),
panel.border = element_rect(colour = "grey69", fill=NA, size=3, linetype = "longdash")) +
  ggtitle("A")  # + 
 #  guides(color = guide_legend(override.aes = list(size = 3, alpha = 0.9, fill = NA)))
chl_zoom


## China - near 
chn_zoom <- ggplot(all_farms, aes(X,Y, col = data_type_plot)) +
  annotation_map_tile(type = "osm", zoomin = 0) + 
  geom_spatial_point(size = 1.3, alpha = 0.7) + 
  scale_color_manual(values = c("forestgreen", "orange1", "red3"), 
                    breaks = c("Known locations", "Modeled locations, known number of farms", "Modeled locations, estimated number of farms")) +
  coord_sf(crs = 4326, xlim = c(121.5, 122.75), ylim = c(29.5, 30.5), expand = FALSE) + # part of Zhejiang province
  theme(legend.position = "bottom", 
        legend.title=element_blank(), 
        axis.title.x = element_blank(), 
        axis.title.y = element_blank(),
        axis.text.x = element_text(angle = 60, hjust = 1),
        legend.key = element_rect(fill = NA),
        text=element_text(family="Times New Roman"),
panel.border = element_rect(colour = "grey69", fill=NA, size=3, linetype = "longdash")) +
  ggtitle("D")
chn_zoom 


## Ecuador - Near Guayaquil
ecu_zoom <- ggplot(all_farms, aes(X,Y, col = data_type_plot)) +
  annotation_map_tile(type = "osm", zoomin = 0) + 
  geom_spatial_point(size = 1.3, alpha = 0.7) + 
  scale_color_manual(values = c("forestgreen", "orange1", "red3"), 
                    breaks = c("Known locations", "Modeled locations, known number of farms", "Modeled locations, estimated number of farms")) +
  coord_sf(crs = 4326, xlim = c(-80.5, -79.5), ylim = c(-3.2, -2.2), expand = FALSE) + # part of Guayas province 
  theme(legend.position = "bottom", 
        legend.title=element_blank(), 
        axis.title.x = element_blank(), 
        axis.title.y = element_blank(),
        axis.text.x = element_text(angle = 60, hjust = 1),
        text=element_text(family="Times New Roman"),
panel.border = element_rect(colour = "grey69", fill=NA, size=3, linetype = "longdash")) +
  ggtitle("B")
ecu_zoom


## USA NW
# usa_zoom <- ggplot(all_farms, aes(X,Y, col = data_type_plot)) +
#   annotation_map_tile(type = "osm", zoomin = 0) + 
#   geom_spatial_point(size = 1.5, alpha = 0.7) + 
#   scale_color_manual(values = c("forestgreen", "orange1", "red3"), 
#                     breaks = c("Known locations", "Modeled locations, known number of farms", "Modeled locations, estimated number of farms")) +
#   coord_sf(crs = 4326, xlim = c(-123, -122), ylim = c(47, 48), expand = FALSE) +
#  # coord_sf(crs = 4326, xlim = c(-80.5, -79.5), ylim = c(-3.2, -2.2), expand = FALSE) + 
#   #coord_sf(crs = 4326, xlim = c(-45, -25), ylim = c(70, 125), expand = FALSE) +
#  # st_crop(xmin = -20, xmax = 45, ymin = 30, ymax = 73) +
#   theme(legend.position = "bottom", 
#         legend.title=element_blank(), 
#         axis.title.x = element_blank(), 
#         axis.title.y = element_blank(),
#         legend.key = element_rect(fill = NA),
#         axis.text.x = element_text(angle = 60, hjust = 1),
#         text=element_text(family="Times New Roman"),
# panel.border = element_rect(colour = "grey69", fill=NA, size=3, linetype = "longdash")) +
#   ggtitle("C") # + 
#  # scale_alpha_manual(values = c(0.7, 0.7, 1))
# 
# usa_zoom


## Australia 
aus_zoom <- ggplot(all_farms %>%
                     filter(iso3c == "AUS"), aes(X,Y, col = data_type_plot)) +
  annotation_map_tile(type = "osm", zoomin = 0) + 
  geom_spatial_point(size = 1.3, alpha = 0.7) + 
  scale_color_manual(values = c("forestgreen", "orange1", "red3"), 
                    breaks = c("Known locations", "Modeled locations, known number of farms", "Modeled locations, estimated number of farms")) +
coord_sf(crs = 4326, xlim = c(135.5, 138), ylim = c(-36, -34), expand = FALSE) + 
  #coord_sf(crs = 4326, xlim = c(135.8, 136.8), ylim = c(-35, -34.5), expand = FALSE) + 
  theme(legend.position = "bottom", 
        legend.title=element_blank(), 
        axis.title.x = element_blank(), 
        axis.title.y = element_blank(),
        axis.text.x = element_text(angle = 60, hjust = 1),
        legend.key = element_rect(fill = NA),
        text=element_text(family="Times New Roman"),
panel.border = element_rect(colour = "grey69", fill=NA, size=3, linetype = "longdash")) +
  ggtitle("C")
aus_zoom




## Chile and Ecuador


plot1 <- (chl_zoom + plot_layout(guides = "collect") & theme(legend.position = "none") & guides(color = guide_legend(override.aes = list(size = 3, alpha = 0.9, fill = NA)))) + (ecu_zoom + theme(legend.position = "none"))

plot1
ggsave("analysis/figs/chl_ecu_zoom.jpg", units = "in", width = 8.07, height = 5.35)

## AUS and China

plot2 <- (aus_zoom +  plot_layout(guides = "collect") & theme(legend.position = "bottom") & guides(color = guide_legend(override.aes = list(size = 3, alpha = 0.9, fill = NA)))) + (chn_zoom + theme(legend.position = "none")) ## save this output in the plot window...


plot2
ggsave("analysis/figs/aus_chn_zoom.jpg", units = "in", width = 8.07, height = 5.35)


## we saved both of those images separately. Then we export them to google drawings, and combine together. Once combined, reupload to figs folder 


plot1 / plot2
```
