---
title: "Validation Testing"
author: "Gage Clawson (UCSB, NCEAS, OHI)"
date: "07/08/2021"
output: html_document
editor_options: 
  chunk_output_type: console
---

## Summary

This script tests conducts an accuracy assessment of our model vs the actual, known mariculture locations. 

We compare out suitability layer with cells that contain data type A farms. This allows us to see how well our suitability layer overlaps with known, comprehensive farms. In bullet 1, we compare one instance of randomly placing farms into our suitabiltiy layer with data type A farms. I believe if we had ran the model thousands of times, randomly placing data type A farms, it would result in the same conclusion (or something very close) as just comparing our entire suitability layer with data type A farms. 

We do these analyses at 4 different resolutions. The native 0.083 degree resolution that we work with all of the global food rasters at. 25km2 and 36km2 equal area, and 0.25 degree resolutions. This allows us to see how well our model works at different resolutions. 

```{r}

library(here)
library(dplyr)
library(sf)
library(raster)
library(mapview)
library(tidyverse)
library(RCurl)
library(ggplot2)
library(fasterize)
library(tabularaster)
library(countrycode)
library(caret)


source(here("_spatial/template_raster.R"))

path <- "/home/shares/food-systems/Food_footprint/_raw_data/Aquaculture_locations"

cell_rast_df <- raster_df(food_raster) %>%
  dplyr::select(1:2)

```

## Method: Compare suitability layer to data type A real farms. 

Use our suitability mask to create a confusion matrix for XX degree cell sizes (about 81km2 at equator, ~10km of coastline) with data type A real farms 

 - What % of data type A real farms fall into a suitable cell?
 - What % fall out of a suitable cell? 
 - What % of suitable cells do not have any farms in them? 
 - etc. 


At 5 arc minute resolution (~10 km of coastline at the equator), when comparing our suitable areas to data type A real farms, we have a balanced accuracy of 0.81. Conducting this same analysis at a coarser resolution of 0.25 degrees (~30 km of coastline at the equator), we see a higher balanced accuracy of xx. Given this, we suggest utilizing our maps at a resolution of 5 arc minutes or larger, as 5 arc minutes produces a defensible accuracy, and aligns with other types of food production maps (e.g. MAPSPAM, FAO, etc). 

When comparing to the coarser resolution of 0.25 degrees, the AUC jumps to 0.84. 

```{r}

## read in the full suitability mask 

suitability_81 <- raster("/home/shares/food-systems/Food_footprint/_raw_data/Aquaculture_locations/global_maps/suitability_rasts/ocean_land_suitability.tif")
plot(suitability_81)

real_rast <- rasterize(real_farms 
                       , 
                       suitability_81, field = "count_farms", fun = "sum")

plot(real_rast, col = 'red')

cellStats(real_rast, "sum") # 8179
plot(real_rast, col = "black")


# norway_suit <- raster::crop(suitability_81, extent(-25, 50, 50, 75))
# norway_farm <- raster::crop(real_rast, extent(-25, 50, 50, 75))
# 
# plot(norway_suit)
# plot(norway_farm, add = TRUE, col = "red")
# 
# chile_suit <- raster::crop(suitability_81, extent(-80, -70, -44, -40))
# chile_farm <- raster::crop(real_rast, extent(-80, -70, -44, -40))
# 
# plot(chile_suit)
# plot(chile_farm, add = TRUE, col = "red")
# 
real_suit_stack <- stack(real_rast, suitability_81)

real_suit_df <- as.data.frame(real_suit_stack) %>%
  mutate(layer_count = ifelse(layer >=1, 1, 0),
         suit_count = ifelse(ocean_land_suitability >=1, 1, 0)) %>%
  mutate(layer_count = ifelse(is.na(layer_count), 0, layer_count),
         suit_count = ifelse(is.na(suit_count), 0, suit_count))
# 
# 
# analysis1 <- real_suit_df %>%
#   filter(layer >= 1, ocean_land_suitability == 1)
# 
# sum(analysis1$layer) # 8179
# 5277/8179 # 0.6451889 = 65% of real farms fall into suitable areas...
# 
# analysis2 <- real_suit_df %>%
#   filter(layer >= 1, is.na(ocean_land_suitability))
# 
# sum(analysis2$layer) # 2902
# 
# 2902/8179 # 35% fall out of suitable areas

confusion_mat <- caret::confusionMatrix(data = as.factor(real_suit_df$suit_count), reference = as.factor(real_suit_df$layer_count))

confusion_mat

# Confusion Matrix and Statistics
# 
#           Reference
# Prediction       0       1
#          0 6402310     932
#          1  118298    1660
#                                           
#                Accuracy : 0.9817          
#                  95% CI : (0.9816, 0.9818)
#     No Information Rate : 0.9996          
#     P-Value [Acc > NIR] : 1               
#                                           
#                   Kappa : 0.0263          
#                                           
#  Mcnemar's Test P-Value : <2e-16          
#                                           
#             Sensitivity : 0.98186         
#             Specificity : 0.64043         
#          Pos Pred Value : 0.99985         
#          Neg Pred Value : 0.01384         
#              Prevalence : 0.99960         
#          Detection Rate : 0.98147         
#    Detection Prevalence : 0.98161         
#       Balanced Accuracy : 0.81114         
#                                           
#        'Positive' Class : 0     

#### Now look at other resolutions


## 36km2 equal area
suitability_36 <- raster("/home/shares/food-systems/Food_footprint/_raw_data/Aquaculture_locations/global_maps/suitability_rasts/ocean_land_suit_36km.tif")
plot(suitability_36)

real_rast <- rasterize(real_farms_cea_36
                       , 
                       suitability_36, field = "count_farms", fun = "sum")

plot(real_rast, col = 'red')

cellStats(real_rast, "sum") # 8552
plot(real_rast, col = "black")


real_suit_stack <- stack(real_rast, suitability_36)

real_suit_df <- as.data.frame(real_suit_stack) %>%
  mutate(layer_count = ifelse(layer >=1, 1, 0),
         suit_count = ifelse(ocean_land_suit_36km >=1, 1, 0)) %>%
  mutate(layer_count = ifelse(is.na(layer_count), 0, layer_count),
         suit_count = ifelse(is.na(suit_count), 0, suit_count))


analysis1 <- real_suit_df %>%
  filter(layer >= 1, ocean_land_suit_36km == 1)

sum(analysis1$layer) # 5505
5505/8552 # 0.6437091 = 64% of real farms fall into suitable areas...


confusion_mat <- caret::confusionMatrix(data = as.factor(real_suit_df$suit_count), reference = as.factor(real_suit_df$layer_count))

confusion_mat

# Confusion Matrix and Statistics
# 
#           Reference
# Prediction        0        1
#          0 13967424     1337
#          1   237288     1951
#                                           
#                Accuracy : 0.9832          
#                  95% CI : (0.9831, 0.9833)
#     No Information Rate : 0.9998          
#     P-Value [Acc > NIR] : 1               
#                                           
#                   Kappa : 0.0156          
#                                           
#  Mcnemar's Test P-Value : <2e-16          
#                                           
#             Sensitivity : 0.983295        
#             Specificity : 0.593370        
#          Pos Pred Value : 0.999904        
#          Neg Pred Value : 0.008155        
#              Prevalence : 0.999769        
#          Detection Rate : 0.983068        
#    Detection Prevalence : 0.983162        
#       Balanced Accuracy : 0.788332        
#                                           
#        'Positive' Class : 0     

# This makes sense given the finer resolution
                               
## 25km2 equal area
suitability_25 <- raster("/home/shares/food-systems/Food_footprint/_raw_data/Aquaculture_locations/global_maps/suitability_rasts/ocean_land_suit_25km.tif")
plot(suitability_25)

real_rast <- rasterize(real_farms_cea_25
                       , 
                       suitability_25, field = "count_farms", fun = "sum")

plot(real_rast, col = 'red')

cellStats(real_rast, "sum") # 8552
plot(real_rast, col = "black")


real_suit_stack <- stack(real_rast, suitability_25)

real_suit_df <- as.data.frame(real_suit_stack) %>%
  mutate(layer_count = ifelse(layer >=1, 1, 0),
         suit_count = ifelse(ocean_land_suit_25km >=1, 1, 0)) %>%
  mutate(layer_count = ifelse(is.na(layer_count), 0, layer_count),
         suit_count = ifelse(is.na(suit_count), 0, suit_count))


analysis1 <- real_suit_df %>%
  filter(layer >= 1, ocean_land_suit_25km == 1)

sum(analysis1$layer) # 5518
5518/8552 # 0.6452292 = 65% of real farms fall into suitable areas...


confusion_mat <- caret::confusionMatrix(data = as.factor(real_suit_df$suit_count), reference = as.factor(real_suit_df$layer_count))

confusion_mat

# Confusion Matrix and Statistics
# 
#           Reference
# Prediction        0        1
#          0 20112053     1505
#          1   343120     2122
#                                           
#                Accuracy : 0.9832          
#                  95% CI : (0.9831, 0.9832)
#     No Information Rate : 0.9998          
#     P-Value [Acc > NIR] : 1               
#                                           
#                   Kappa : 0.0118          
#                                           
#  Mcnemar's Test P-Value : <2e-16          
#                                           
#             Sensitivity : 0.983226        
#             Specificity : 0.585057        
#          Pos Pred Value : 0.999925        
#          Neg Pred Value : 0.006146        
#              Prevalence : 0.999823        
#          Detection Rate : 0.983051        
#    Detection Prevalence : 0.983125        
#       Balanced Accuracy : 0.784141        
#                                           
#        'Positive' Class : 0    


## quarter degree cells 

suitability_quart <- raster("/home/shares/food-systems/Food_footprint/_raw_data/Aquaculture_locations/global_maps/suitability_rasts/ocean_land_suit_quart.tif")
plot(suitability_quart)

real_rast <- rasterize(real_farms_quart
                       , 
                       suitability_quart, field = "count_farms", fun = "sum")

plot(real_rast, col = 'red')

cellStats(real_rast, "sum") # 8179
plot(real_rast, col = "black")


real_suit_stack <- stack(real_rast, suitability_quart)

real_suit_df <- as.data.frame(real_suit_stack) %>%
  mutate(layer_count = ifelse(layer >=1, 1, 0),
         suit_count = ifelse(ocean_land_suit_quart >=1, 1, 0)) %>%
  mutate(layer_count = ifelse(is.na(layer_count), 0, layer_count),
         suit_count = ifelse(is.na(suit_count), 0, suit_count))


analysis1 <- real_suit_df %>%
  filter(layer >= 1, ocean_land_suit_quart == 1)

sum(analysis1$layer) # 5380
5380/8179 # 0.6577821 = 66% of real farms fall into suitable areas...


confusion_mat <- caret::confusionMatrix(data = as.factor(real_suit_df$suit_count), reference = as.factor(real_suit_df$layer_count))

confusion_mat

# Confusion Matrix and Statistics
# 
#           Reference
# Prediction      0      1
#          0 709283    325
#          1  13933    779
#                                         
#                Accuracy : 0.9803        
#                  95% CI : (0.98, 0.9806)
#     No Information Rate : 0.9985        
#     P-Value [Acc > NIR] : 1             
#                                         
#                   Kappa : 0.0959        
#                                         
#  Mcnemar's Test P-Value : <2e-16        
#                                         
#             Sensitivity : 0.98073       
#             Specificity : 0.70562       
#          Pos Pred Value : 0.99954       
#          Neg Pred Value : 0.05295       
#              Prevalence : 0.99848       
#          Detection Rate : 0.97924       
#    Detection Prevalence : 0.97969       
#       Balanced Accuracy : 0.84318       
#                                         
#        'Positive' Class : 0  
```




