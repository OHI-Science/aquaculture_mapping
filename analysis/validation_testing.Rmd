---
title: "Validation Testing"
author: "Gage Clawson (UCSB, NCEAS, OHI)"
date: "07/08/2021"
output: html_document
editor_options: 
  chunk_output_type: console
---

## Summary

This script tests conducts an accuracy assessment of our model vs the actual, known mariculture locations. 

We try this in two different ways. 

1) We compare our random placement of data type A farms into our suitable areas, to the locations of real mariculture locations. The analysis conducted uses a confusion matrix, which calculates the AUC (area under the curve) to test the accuracy of the placement of our points. However, we decided to not use this portion of the analysis in the final manuscript, because the accuracy assessment which makes more sense is conducted in bullet 2 below. 

2) We compare out suitability layer with cells that contain data type A farms. This allows us to see how well our suitability layer overlaps with known, comprehensive farms. In bullet 1, we compare one instance of randomly placing farms into our suitabiltiy layer with data type A farms. I believe if we had ran the model thousands of times, randomly placing data type A farms, it would result in the same conclusion (or something very close) as just comparing our entire suitability layer with data type A farms. 

We do each of these analyses at 4 different resolutions. The native 0.083 degree resolution that we work with all of the global food rasters at. 25km2 and 36km2 equal area, and 0.25 degree resolutions. This allows us to see how well our model works at different resolutions. 

```{r}

library(here)
library(dplyr)
library(sf)
library(raster)
library(mapview)
library(tidyverse)
library(RCurl)
library(ggplot2)
library(fasterize)
library(tabularaster)
library(countrycode)
library(caret)


source(here("_spatial/template_raster.R"))

path <- "/home/shares/food-systems/Food_footprint/_raw_data/Aquaculture_locations"

cell_rast_df <- raster_df(food_raster) %>%
  dplyr::select(1:2)

```

```{r}

## establish CRSs and read in the EEZ masks

## food 81km2 at equator 
eez_81 <- raster(file.path("/home/shares/food-systems/Food_footprint/_raw_data/Aquaculture_locations/global_maps/data_type_A_eez/eez_validation_mask.tif"))
plot(raster::area(eez_81))
plot(eez_81)
cellStats(raster::area(eez_81), "mean")

test <- data.frame(raster::values(raster::area(eez_81)))


## 36km2 equal area
eez_36_cea <- raster(file.path("/home/shares/food-systems/Food_footprint/_raw_data/Aquaculture_locations/global_maps/data_type_A_eez/eez_validation_mask_cea_36km.tif"))
plot(eez_36_cea)

new_crs <- "+proj=cea +lat_ts=45 +lon_0=0 +x_0=0 +y_0=0 +datum=WGS84 +units=m +no_defs"
new_raster <- raster(nrows=3000, ncols=4736, xmn=-14207430, xmx=14208570, ymn=-9000182, ymx=8999818, crs = new_crs)

## 25km2 equal area
eez_25_cea <- raster(file.path("/home/shares/food-systems/Food_footprint/_raw_data/Aquaculture_locations/global_maps/data_type_A_eez/eez_validation_mask_cea_25km.tif"))

cea_25_crs <- crs(eez_25_cea)
plot(eez_25_cea)


## 1/4 degree cells 
eez_quart_cell <- raster(file.path("/home/shares/food-systems/Food_footprint/_raw_data/Aquaculture_locations/global_maps/data_type_A_eez/eez_validation_mask_quarter_degree.tif"))

quarter_crs <- crs(eez_quart_cell)


```


## Method 1: Compare randomly placed farms to real farms

Read in validation dataset.. i.e. the farms that we placed in data type A countries using our modelling technique.

```{r}
validation_all <- readRDS(file.path("data/all_validation_farms_resubmission.rds"))  %>%
  mutate(species_group = case_when(type == "salmon" ~ "Salmonidae fish",
                          type == "bivalve" ~ "Unfed or algae fed bivalve molluscs",
                          type == "shrimp" ~ "Shrimps and prawns", 
                          type == "tuna" ~ "Bluefin tuna", 
                          type == "marine_fish_general" ~ "General marine fish"))


table_3 <- read_csv("analysis/tables/SI_table_3.csv")

iso <-   data.frame(iso3c = countrycode(table_3$country, origin = 'country.name', destination = 'iso3c'))

table_3_iso3c <- table_3 %>%
  cbind(iso)

data_type_val <- validation_all %>%
  left_join(table_3_iso3c, by = c("iso3c", "species_group"))

data_type_A <- data_type_val %>%
 filter(data_type_2 %in% c("A"))


table_3_A <- table_3_iso3c %>%
  filter(data_type_2 %in% c("A"))

```


Split data into real and modelled

```{r}
validation_farms <- data_type_A %>%
 filter(source == "modeled validation") %>%
  mutate(count_farms = 1) 


val_farms_cea_36 <- validation_farms %>%
  st_transform(crs = new_crs)

val_farms_cea_25 <- validation_farms %>%
  st_transform(crs = cea_25_crs)

val_farms_quarter <- validation_farms %>%
  st_transform(crs = quarter_crs)



real_farms <- data_type_A %>%
  filter(source == "real") %>%
  mutate(count_farms = 1)


real_farms_cea_36 <- real_farms %>%
  st_transform(crs = new_crs)

real_farms_cea_25 <- real_farms %>%
  st_transform(crs = cea_25_crs)


real_farms_quart <- real_farms %>%
  st_transform(crs = quarter_crs)
```


Rasterize data to count number of farms per raster cell with 36km2 equal area 

```{r}

val_rast <- rasterize(val_farms_cea_36, new_raster, field = "count_farms", fun = "sum")
plot(val_rast)

cellStats(val_rast, "sum") # 8552

plot(val_rast, col = "black")
#s <- raster::select(val_rast)
#plot(s)



real_rast <- rasterize(real_farms_cea_36, new_raster, field = "count_farms", fun = "sum")
plot(real_rast)

cellStats(real_rast, "sum") # 8552
plot(real_rast, col = "black")

rast_stack <- stack(val_rast, real_rast)
cellStats(rast_stack, "sum")

# layer.1 layer.2 
#    8552    8552 

```

 
Use our EEZ mask to create a confusion matrix for CEA 36km2 cell sizes 

 - AUC of ~0.60
```{r}


plot(eez_36_cea, col = "black")

world_coast <- as.data.frame(eez_36_cea) %>%
  mutate(cell = row_number()) %>%
  filter(!is.na(eez_validation_mask_cea_36km))


eez_cells_df <- as.data.frame(rast_stack) %>%
  rename("predicted" = "layer.1", "real" = "layer.2") %>%
  mutate(pred_count = ifelse(predicted >=1, 1, 0),
         real_mod_count = ifelse(predicted >=1&real>=1, 1, 0)) %>%
  mutate(real_count = ifelse(real>=1,1,0)) %>%
  mutate(pred_count = ifelse(is.na(pred_count), 0, pred_count),
         real_count = ifelse(is.na(real_count), 0, real_count), 
         real = ifelse(is.na(real), 0, real),
         predicted = ifelse(is.na(predicted), 0, predicted)) %>%
  mutate(cell = row_number()) %>% 
  filter(cell %in% c(world_coast$cell)) 

sum(eez_cells_df$predicted, na.rm = TRUE) # 8535

sum(eez_cells_df$real, na.rm = TRUE) # 8473

## still missing some farms.. but nothing egregious. This is probably ok. The results wouldn't change much even if we had the extra ~80 farms 


test <- rast_stack*eez_36_cea

cellStats(test,"sum") 
# layer.1 layer.2 
#    8535    8473 

## we are losing some farms...

#### make a confusion matrix 

confusion_mat <- caret::confusionMatrix(data = as.factor(eez_cells_df$pred_count), reference = as.factor(eez_cells_df$real_count))

confusion_mat

# Confusion Matrix and Statistics
#           Reference
# Prediction       0       1
#          0 1171909    2552
#          1    2721     682
#                                           
#                Accuracy : 0.9955          
#                  95% CI : (0.9954, 0.9956)
#     No Information Rate : 0.9973          
#     P-Value [Acc > NIR] : 1.00000         
#                                           
#                   Kappa : 0.2033          
#                                           
#  Mcnemar's Test P-Value : 0.02069         
#                                           
#             Sensitivity : 0.9977          
#             Specificity : 0.2109          
#          Pos Pred Value : 0.9978          
#          Neg Pred Value : 0.2004          
#              Prevalence : 0.9973          
#          Detection Rate : 0.9949          
#    Detection Prevalence : 0.9971          
#       Balanced Accuracy : 0.6043          
#                                           
#        'Positive' Class : 0  

# library(pROC)
# roc(eez_cells_df$real_count, eez_cells_df$pred_count, plot = TRUE) # 0.6019
# 
# 
# library(pROC)
# library(randomForest)
# 
# 
# roc(eez_cells_df$real_count, eez_cells_df$pred_count, plot = TRUE, percent = TRUE, xlab = "False Positive Percentage", ylab = "True Positive Percentage", col = "#377eb8", lwd = 4, print.auc = TRUE) # 0.6068
# 
# roc.info <- roc(eez_cells_df$real_count, eez_cells_df$pred_count, legacy.axes = TRUE)
# 
# roc.df <- data.frame(tpp = roc.info$sensitivities*100,
#                      fpp = (1-roc.info$specificities)*100,
#                      thresholds = roc.info$thresholds)
# 
# 
# #### ROC curve try #2
# # https://www.datatechnotes.com/2019/03/how-to-create-roc-curve-in-r.html
# 
# library(ROCR)
#   
#  
# pred = eez_cells_df$pred_count
# 
# pred = prediction(pred, eez_cells_df$real_count)
# 
# perf = performance(pred, "acc")
# plot(perf)
# 
# perf_cost <- performance(pred, "cost")
# plot(perf_cost)
# 
# roc = performance(pred, "tpr", "fpr")
# 
# plot(roc, colorize = T, lwd=2)
# abline(a=0, b=1)
# 
# auc = performance(pred, measure = "auc")
# print(auc@y.values)
# # 0.6091016

```




Use our EEZ mask to create a confusion matrix for CEA 25km2 cell sizes 

 - AUC of ~0.59 - worse than 36km2... makes sense! 
```{r}

val_rast <- rasterize(val_farms_cea_25, eez_25_cea, field = "count_farms", fun = "sum")
plot(val_rast)

cellStats(val_rast, "sum")

plot(val_rast, col = "black")
#s <- raster::select(val_rast)
#plot(s)



real_rast <- rasterize(real_farms_cea_25, eez_25_cea, field = "count_farms", fun = "sum")
plot(real_rast)

cellStats(real_rast, "sum") # 8552
plot(real_rast, col = "black")

rast_stack <- stack(val_rast, real_rast)
cellStats(rast_stack, "sum")
 
# layer.1 layer.2 
#    8552    8552 



plot(eez_25_cea, col = "black")

world_coast <- as.data.frame(eez_25_cea) %>%
  mutate(cell = row_number()) %>%
  filter(!is.na(eez_validation_mask_cea_25km))


eez_cells_df <- as.data.frame(rast_stack) %>%
  rename("predicted" = "layer.1", "real" = "layer.2") %>%
  mutate(pred_count = ifelse(predicted >=1, 1, 0),
         real_mod_count = ifelse(predicted >=1&real>=1, 1, 0)) %>%
  mutate(real_count = ifelse(real>=1,1,0)) %>%
  mutate(pred_count = ifelse(is.na(pred_count), 0, pred_count),
         real_count = ifelse(is.na(real_count), 0, real_count), 
         real = ifelse(is.na(real), 0, real),
         predicted = ifelse(is.na(predicted), 0, predicted)) %>%
  mutate(cell = row_number()) %>% 
  filter(cell %in% c(world_coast$cell)) 

sum(eez_cells_df$predicted, na.rm = TRUE) # 8536

sum(eez_cells_df$real, na.rm = TRUE) # 8482

## still missing some farms.. but nothing egregious. This is probably ok. The results wouldn't change much even if we had the extra ~80 farms. This is likely due to reprojection weirdness


test <- rast_stack*eez_25_cea

cellStats(test,"sum") 
# layer.1 layer.2 
#    8536    8482 


#### make a confusion matrix 

confusion_mat <- caret::confusionMatrix(data = as.factor(eez_cells_df$pred_count), reference = as.factor(eez_cells_df$real_count))

confusion_mat

# Confusion Matrix and Statistics
# 
#           Reference
# Prediction       0       1
#          0 1689310    2929
#          1    3100     639
#                                           
#                Accuracy : 0.9964          
#                  95% CI : (0.9964, 0.9965)
#     No Information Rate : 0.9979          
#     P-Value [Acc > NIR] : 1.00000         
#                                           
#                   Kappa : 0.1731          
#                                           
#  Mcnemar's Test P-Value : 0.02857         
#                                           
#             Sensitivity : 0.9982          
#             Specificity : 0.1791          
#          Pos Pred Value : 0.9983          
#          Neg Pred Value : 0.1709          
#              Prevalence : 0.9979          
#          Detection Rate : 0.9961          
#    Detection Prevalence : 0.9978          
#       Balanced Accuracy : 0.5886          
#                                           
#        'Positive' Class : 0               
                             



```


Use our EEZ mask to create a confusion matrix for 0.25 X 0.25 degree cell sizes (about 769.3152km2 at equator). Average cell size is 490.3108 km2

 - AUC of ~72.05 ; makes sense that is it better! 
 
```{r}
test <- raster::area(eez_quart_cell)

cellStats(test, "mean") # 490.3108

mean(test@data@values) # 490.3108

val_rast <- rasterize(val_farms_quarter, eez_quart_cell, field = "count_farms", fun = "sum")
plot(val_rast)

cellStats(val_rast, "sum")

plot(val_rast, col = "black")


real_rast <- rasterize(real_farms_quart, eez_quart_cell, field = "count_farms", fun = "sum")
plot(real_rast)

cellStats(real_rast, "sum") # 8552
plot(real_rast, col = "black")

rast_stack <- stack(val_rast, real_rast)
cellStats(rast_stack, "sum")

# layer.1 layer.2 
#    8552    8552 



plot(eez_quart_cell, col = "black")

world_coast <- as.data.frame(eez_quart_cell) %>%
  mutate(cell = row_number()) %>%
  filter(!is.na(eez_validation_mask_quarter_degree))


eez_cells_df <- as.data.frame(rast_stack) %>%
  rename("predicted" = "layer.1", "real" = "layer.2") %>%
  mutate(pred_count = ifelse(predicted >=1, 1, 0),
         real_mod_count = ifelse(predicted >=1&real>=1, 1, 0)) %>%
  mutate(real_count = ifelse(real>=1,1,0)) %>%
  mutate(pred_count = ifelse(is.na(pred_count), 0, pred_count),
         real_count = ifelse(is.na(real_count), 0, real_count), 
         real = ifelse(is.na(real), 0, real),
         predicted = ifelse(is.na(predicted), 0, predicted)) %>%
  mutate(cell = row_number()) %>% 
  filter(cell %in% c(world_coast$cell)) 

sum(eez_cells_df$predicted, na.rm = TRUE) # 8124

sum(eez_cells_df$real, na.rm = TRUE) # 8173

## still missing some farms..


test <- rast_stack*eez_quart_cell

cellStats(test,"sum") 
# layer.1 layer.2 
#    8124    8173  


#### make a confusion matrix 

confusion_mat <- caret::confusionMatrix(data = as.factor(eez_cells_df$pred_count), reference = as.factor(eez_cells_df$real_count))

confusion_mat

# Confusion Matrix and Statistics
# 
#           Reference
# Prediction     0     1
#          0 84570   639
#          1   902   514
#                                           
#                Accuracy : 0.9822          
#                  95% CI : (0.9813, 0.9831)
#     No Information Rate : 0.9867          
#     P-Value [Acc > NIR] : 1               
#                                           
#                   Kappa : 0.3912          
#                                           
#  Mcnemar's Test P-Value : 2.486e-11       
#                                           
#             Sensitivity : 0.9894          
#             Specificity : 0.4458          
#          Pos Pred Value : 0.9925          
#          Neg Pred Value : 0.3630          
#              Prevalence : 0.9867          
#          Detection Rate : 0.9763          
#    Detection Prevalence : 0.9837          
#       Balanced Accuracy : 0.7176          
#                                           
#        'Positive' Class : 0               
                                


```



## Method 2: Compare suitability layer to data type A real farms. 

Use our suitability mask to create a confusion matrix for XX degree cell sizes (about 81km2 at equator, ~10km of coastline) with data type A real farms 

 - What % of data type A real farms fall into a suitable cell?
 - What % fall out of a suitable cell? 
 - What % of suitable cells do not have any farms in them? 
 - etc. 


At 5 arc minute resolution (~10 km of coastline at the equator), when comparing our suitable areas to data type A real farms, we have a balanced accuracy of 0.81. Conducting this same analysis at a coarser resolution of 0.25 degrees (~30 km of coastline at the equator), we see a higher balanced accuracy of xx. Given this, we suggest utilizing our maps at a resolution of 5 arc minutes or larger, as 5 arc minutes produces a defensible accuracy, and aligns with other types of food production maps (e.g. MAPSPAM, FAO, etc). 

When comparing to the coarser resolution of 0.25 degrees, the AUC jumps to 0.84. 

```{r}

## read in the full suitability mask 

suitability_81 <- raster("/home/shares/food-systems/Food_footprint/_raw_data/Aquaculture_locations/global_maps/suitability_rasts/ocean_land_suitability.tif")
plot(suitability_81)

real_rast <- rasterize(real_farms 
                       , 
                       suitability_81, field = "count_farms", fun = "sum")

plot(real_rast, col = 'red')

cellStats(real_rast, "sum") # 8179
plot(real_rast, col = "black")


# norway_suit <- raster::crop(suitability_81, extent(-25, 50, 50, 75))
# norway_farm <- raster::crop(real_rast, extent(-25, 50, 50, 75))
# 
# plot(norway_suit)
# plot(norway_farm, add = TRUE, col = "red")
# 
# chile_suit <- raster::crop(suitability_81, extent(-80, -70, -44, -40))
# chile_farm <- raster::crop(real_rast, extent(-80, -70, -44, -40))
# 
# plot(chile_suit)
# plot(chile_farm, add = TRUE, col = "red")
# 
real_suit_stack <- stack(real_rast, suitability_81)

real_suit_df <- as.data.frame(real_suit_stack) %>%
  mutate(layer_count = ifelse(layer >=1, 1, 0),
         suit_count = ifelse(ocean_land_suitability >=1, 1, 0)) %>%
  mutate(layer_count = ifelse(is.na(layer_count), 0, layer_count),
         suit_count = ifelse(is.na(suit_count), 0, suit_count))
# 
# 
# analysis1 <- real_suit_df %>%
#   filter(layer >= 1, ocean_land_suitability == 1)
# 
# sum(analysis1$layer) # 8179
# 5277/8179 # 0.6451889 = 65% of real farms fall into suitable areas...
# 
# analysis2 <- real_suit_df %>%
#   filter(layer >= 1, is.na(ocean_land_suitability))
# 
# sum(analysis2$layer) # 2902
# 
# 2902/8179 # 35% fall out of suitable areas

confusion_mat <- caret::confusionMatrix(data = as.factor(real_suit_df$suit_count), reference = as.factor(real_suit_df$layer_count))

confusion_mat

# Confusion Matrix and Statistics
# 
#           Reference
# Prediction       0       1
#          0 6402310     932
#          1  118298    1660
#                                           
#                Accuracy : 0.9817          
#                  95% CI : (0.9816, 0.9818)
#     No Information Rate : 0.9996          
#     P-Value [Acc > NIR] : 1               
#                                           
#                   Kappa : 0.0263          
#                                           
#  Mcnemar's Test P-Value : <2e-16          
#                                           
#             Sensitivity : 0.98186         
#             Specificity : 0.64043         
#          Pos Pred Value : 0.99985         
#          Neg Pred Value : 0.01384         
#              Prevalence : 0.99960         
#          Detection Rate : 0.98147         
#    Detection Prevalence : 0.98161         
#       Balanced Accuracy : 0.81114         
#                                           
#        'Positive' Class : 0     

#### Now look at other resolutions


## 36km2 equal area
suitability_36 <- raster("/home/shares/food-systems/Food_footprint/_raw_data/Aquaculture_locations/global_maps/suitability_rasts/ocean_land_suit_36km.tif")
plot(suitability_36)

real_rast <- rasterize(real_farms_cea_36
                       , 
                       suitability_36, field = "count_farms", fun = "sum")

plot(real_rast, col = 'red')

cellStats(real_rast, "sum") # 8552
plot(real_rast, col = "black")


real_suit_stack <- stack(real_rast, suitability_36)

real_suit_df <- as.data.frame(real_suit_stack) %>%
  mutate(layer_count = ifelse(layer >=1, 1, 0),
         suit_count = ifelse(ocean_land_suit_36km >=1, 1, 0)) %>%
  mutate(layer_count = ifelse(is.na(layer_count), 0, layer_count),
         suit_count = ifelse(is.na(suit_count), 0, suit_count))


analysis1 <- real_suit_df %>%
  filter(layer >= 1, ocean_land_suit_36km == 1)

sum(analysis1$layer) # 5505
5505/8552 # 0.6437091 = 64% of real farms fall into suitable areas...


confusion_mat <- caret::confusionMatrix(data = as.factor(real_suit_df$suit_count), reference = as.factor(real_suit_df$layer_count))

confusion_mat

# Confusion Matrix and Statistics
# 
#           Reference
# Prediction        0        1
#          0 13967424     1337
#          1   237288     1951
#                                           
#                Accuracy : 0.9832          
#                  95% CI : (0.9831, 0.9833)
#     No Information Rate : 0.9998          
#     P-Value [Acc > NIR] : 1               
#                                           
#                   Kappa : 0.0156          
#                                           
#  Mcnemar's Test P-Value : <2e-16          
#                                           
#             Sensitivity : 0.983295        
#             Specificity : 0.593370        
#          Pos Pred Value : 0.999904        
#          Neg Pred Value : 0.008155        
#              Prevalence : 0.999769        
#          Detection Rate : 0.983068        
#    Detection Prevalence : 0.983162        
#       Balanced Accuracy : 0.788332        
#                                           
#        'Positive' Class : 0     

# This makes sense given the finer resolution
                               
## 25km2 equal area
suitability_25 <- raster("/home/shares/food-systems/Food_footprint/_raw_data/Aquaculture_locations/global_maps/suitability_rasts/ocean_land_suit_25km.tif")
plot(suitability_25)

real_rast <- rasterize(real_farms_cea_25
                       , 
                       suitability_25, field = "count_farms", fun = "sum")

plot(real_rast, col = 'red')

cellStats(real_rast, "sum") # 8552
plot(real_rast, col = "black")


real_suit_stack <- stack(real_rast, suitability_25)

real_suit_df <- as.data.frame(real_suit_stack) %>%
  mutate(layer_count = ifelse(layer >=1, 1, 0),
         suit_count = ifelse(ocean_land_suit_25km >=1, 1, 0)) %>%
  mutate(layer_count = ifelse(is.na(layer_count), 0, layer_count),
         suit_count = ifelse(is.na(suit_count), 0, suit_count))


analysis1 <- real_suit_df %>%
  filter(layer >= 1, ocean_land_suit_25km == 1)

sum(analysis1$layer) # 5518
5518/8552 # 0.6452292 = 65% of real farms fall into suitable areas...


confusion_mat <- caret::confusionMatrix(data = as.factor(real_suit_df$suit_count), reference = as.factor(real_suit_df$layer_count))

confusion_mat

# Confusion Matrix and Statistics
# 
#           Reference
# Prediction        0        1
#          0 20112053     1505
#          1   343120     2122
#                                           
#                Accuracy : 0.9832          
#                  95% CI : (0.9831, 0.9832)
#     No Information Rate : 0.9998          
#     P-Value [Acc > NIR] : 1               
#                                           
#                   Kappa : 0.0118          
#                                           
#  Mcnemar's Test P-Value : <2e-16          
#                                           
#             Sensitivity : 0.983226        
#             Specificity : 0.585057        
#          Pos Pred Value : 0.999925        
#          Neg Pred Value : 0.006146        
#              Prevalence : 0.999823        
#          Detection Rate : 0.983051        
#    Detection Prevalence : 0.983125        
#       Balanced Accuracy : 0.784141        
#                                           
#        'Positive' Class : 0    


## quarter degree cells 

suitability_quart <- raster("/home/shares/food-systems/Food_footprint/_raw_data/Aquaculture_locations/global_maps/suitability_rasts/ocean_land_suit_quart.tif")
plot(suitability_quart)

real_rast <- rasterize(real_farms_quart
                       , 
                       suitability_quart, field = "count_farms", fun = "sum")

plot(real_rast, col = 'red')

cellStats(real_rast, "sum") # 8179
plot(real_rast, col = "black")


real_suit_stack <- stack(real_rast, suitability_quart)

real_suit_df <- as.data.frame(real_suit_stack) %>%
  mutate(layer_count = ifelse(layer >=1, 1, 0),
         suit_count = ifelse(ocean_land_suit_quart >=1, 1, 0)) %>%
  mutate(layer_count = ifelse(is.na(layer_count), 0, layer_count),
         suit_count = ifelse(is.na(suit_count), 0, suit_count))


analysis1 <- real_suit_df %>%
  filter(layer >= 1, ocean_land_suit_quart == 1)

sum(analysis1$layer) # 5380
5380/8179 # 0.6577821 = 66% of real farms fall into suitable areas...


confusion_mat <- caret::confusionMatrix(data = as.factor(real_suit_df$suit_count), reference = as.factor(real_suit_df$layer_count))

confusion_mat

# Confusion Matrix and Statistics
# 
#           Reference
# Prediction      0      1
#          0 709283    325
#          1  13933    779
#                                         
#                Accuracy : 0.9803        
#                  95% CI : (0.98, 0.9806)
#     No Information Rate : 0.9985        
#     P-Value [Acc > NIR] : 1             
#                                         
#                   Kappa : 0.0959        
#                                         
#  Mcnemar's Test P-Value : <2e-16        
#                                         
#             Sensitivity : 0.98073       
#             Specificity : 0.70562       
#          Pos Pred Value : 0.99954       
#          Neg Pred Value : 0.05295       
#              Prevalence : 0.99848       
#          Detection Rate : 0.97924       
#    Detection Prevalence : 0.97969       
#       Balanced Accuracy : 0.84318       
#                                         
#        'Positive' Class : 0  
```

Take a quick look at the gentry files to see what resolution they use. 
```{r}
# gentry <- raster(file.path("/home/shares/food-systems/Food_footprint/_raw_data/Aquaculture_locations/global_maps/suitability_rasts/gentry/karakoenig"))
```




