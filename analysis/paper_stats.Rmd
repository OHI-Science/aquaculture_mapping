---
title: "Summary stats for paper"
author: "Gage Clawson (UCSB, NCEAS, OHI)"
date: "04/26/2021"
output: html_document
editor_options: 
  chunk_output_type: console
---

This script takes our final farms dataset and calculates summary statistics that will be used in the paper. 

```{r}

library(here)
library(dplyr)
library(sf)
library(raster)
library(mapview)
library(tidyverse)
library(RCurl)
library(mosaic)
library(googlesheets4)
library(janitor)
library(countrycode)

source(here("_spatial/template_raster.R"))

path <- "/home/shares/food-systems/Food_footprint/_raw_data/Aquaculture_locations"

```



# Read in farms data

```{r}

all_farms <- read_csv("all_marine_aquaculture_farms_sources_31km.csv")

all_farms_sf <- all_farms %>%
  st_as_sf(coords =c("X", "Y")) 

# test <- all_farms_sf %>%
#   filter(iso3c == "USA")
# mapview(test)


```


```{r}
sources <- read_csv("analysis/data/mariculture_mapping_sources.csv") %>%
  clean_names() %>%
  mutate(type = case_when(species == "Salmonids" ~ "salmon",
                          species == "Unfed or algae fed shellfish" ~ "bivalve",
                          species == "Shrimp" ~ "shrimp", 
                          species == "Tuna" ~ "tuna", 
                          species == "General Marine Fish" ~ "marine_fish_general", 
                          species == "Crustaceans" ~ "crustaceans"))


## Numbers by data type
by_data_type <- all_farms %>%
  group_by(data_type) %>%
  summarise(n_obs = n()) %>%
  mutate(total_obs = sum(n_obs)) %>% 
  ungroup() %>%
  mutate(pct = n_obs/total_obs*100)

by_data_type
# A tibble: 3 x 4
#   data_type                                   n_obs total_obs   pct
#   <chr>                                       <int>     <int> <dbl>
# 1 known location                               9750     95341  10.2
# 2 modeled location, estimated number of farms 75072     95341  78.7
# 3 modeled location, known number of farms     10519     95341  11.0

# How many countries have spatial locations information?
known_countries <- all_farms %>%
  filter(data_type == "known location") %>%
  distinct(iso3c)


# Some of the worldâ€™s largest aquaculture producers had a noticeable paucity of aquaculture location data, particularly China, whose represented 77% of all points, and only had 15 known location points

chn_data_estimated <- all_farms %>%
  filter(iso3c == "CHN") #%>%
  #filter(data_type == "modeled location, estimated number of farms")
# 58166 points
58151/95342 # 0.6099201 = 61%


chn_data_known <- all_farms %>%
  filter(iso3c == "CHN") %>%
  filter(data_type == "known location") # 15 locations 

# Chile, Norway, and Ireland provided a substantial number of known locations (>1000).
top_known <- all_farms %>%
  filter(data_type == "known location") %>%
  group_by(iso3c) %>%
    summarise(n_obs = n())


# Only 5 countries (Cambodia, Mauritius, Myanmar, North Korea, and Russia) had no form of farm data at all, however, these countries only account for 0.5% of marine aquaculture production included.

no_info_at_all <- sources %>%
  dplyr::filter(known_farms_location == 0, known_farms_no_location == 0) ## only 5 with no information at all

mar_production <- read_csv("marine/STEP1_species_groups/int/tonnes_per_country_group.csv")

no_info_production <- mar_production %>%
  filter(country %in% c("Cambodia", "Mauritius", "Myanmar", "Korea, Dem. People's Rep", "Russian Federation"))
sum(no_info_production$total_tonnes) # 152800.1

sum(mar_production$total_tonnes) # 29623515
152800.1/29623515

chn_production <- mar_production %>%
  filter(country == "China")
sum(chn_production$total_tonnes)
17696822/29623515

# Per species group, salmon was the most data rich (98% of points had location information, 1.13% of points were known with no location information, 0.87% estimated), followed by Tuna (34% of points had location information, 66% of points were known with no location information, 0% estimated).


by_species_data_type <- all_farms %>%
  group_by(species, data_type) %>%
  summarise(n_obs = n()) %>%
  mutate(total_obs = sum(n_obs)) %>% 
  ungroup() %>%
  mutate(pct = n_obs/total_obs*100)



## How much fish and invertebrate mariculture production was included in our assessment? 

fao <- read_csv("data/fao_aquaculture_clean.csv")
mar_sp_list <- read_csv("https://raw.githubusercontent.com/OHI-Science/ohiprep_v2020/gh-pages/globalprep/mar/v2020/raw/species_list.csv")

fw <- fao %>%
  dplyr::filter(environment == "Freshwater") %>%
  group_by(species) %>%
  summarize(total = sum(value)) %>%
  ungroup() %>%
  arrange(total)

data.frame(fw)

test <- fao %>%
  filter(year == 2017) %>%
  left_join(mar_sp_list, by = c("species" = "FAO_name")) %>%
  mutate(environment2 = ifelse(Taxon_code == "AL", "seaweed", environment)) %>%
  mutate(environment = ifelse(is.na(environment2), environment, environment2)) %>%
  filter(environment != "Freshwater") %>%
  group_by(environment, year) %>%
  summarise(prod = sum(value, na.rm = TRUE)) %>%
  ungroup() %>%
  mutate(total = sum(prod)) %>%
  mutate(pct = prod/total)

## total fish and invertebrate mariculture production included is: 8090542 + 22920871 = 31011413

## we include: 29623515
prod_total <- read_csv("/home/shares/food-systems/Food_footprint/all_food_systems/dataprep/aquaculture/marine/production_extracted_final.csv")

sum(prod_total$total_tonnes) # 29623515

29623515/31011413 # 0.9552456
```


```{r}
prod_per_farm <- read_csv("marine/output/all_points_to_add.csv") %>%
  distinct(type,avg_tonnes_per_farm)

production_by_grouping <- all_farms %>%
  group_by(iso3c, species_group, data_type) %>%
  summarise(n_obs = n())


```


Countries with comprehensive farm locations 
```{r}

all_farms <- read_csv("all_marine_aquaculture_farms_sources_31km.csv")

unique(sort(all_farms$country))

country_spp_combos <- all_farms %>%
  distinct(country, species_group)


## read in each of the comprehensive locations 

bivalve_comp <- read_csv("marine/bivalve/bivalve_farms/output/bivalve_comp_tonnes_per_farm.csv")


shrimp_comp <- read_csv("marine/shrimp/shrimp_farms/output/shrimp_comp_tonnes_per_farm.csv")



salmon_comp <- read_csv("marine/salmon/salmon_farms/output/salmon_comp_tonnes_per_farm.csv")

tuna_comp <- read_csv("marine/tuna/tuna_farms/output/tuna_comp_tonnes_per_farm.csv")

finfish_comp <- read_csv("marine/marine_fish_general/finfish_farms/output/finfish_comp_tonnes_per_farm.csv")



all_comp_farms <- rbind(finfish_comp, bivalve_comp, salmon_comp, tuna_comp, shrimp_comp) %>%
    mutate(Species = case_when(
      type == "salmon" ~ "Salmonidae fish", 
      type == "bivalve" ~ "Unfed or algae fed bivalve molluscs",
      type == "marine_fish_general" ~ "General marine fish", 
      type == "shrimp" ~ "Shrimps and prawns", 
      type == "tuna" ~ "Bluefin tuna"
    )) %>%
  mutate(tonnes_per_farm = round(tonnes_per_farm, 2)) %>%
  dplyr::select("Country" = "country", Species, "Number of farms" = "n_farms", "Tonnes of production" = "fao_tonnes_production", "Tonnes per farm" = "tonnes_per_farm") %>%
  arrange(Country) 

 unique(all_comp_farms$Country)

write.csv(all_comp_farms, "analysis/output/all_comp_farms.csv", row.names = FALSE)


sum(all_comp_farms$`Tonnes of production`) # 4963244

4963244/29623515 # 0.1675441 = ~17%


comp_across_all <- all_comp_farms %>%
  full_join(country_spp_combos, by = c("Country" = "country", "Species" = "species_group")) %>%
  mutate(Country = case_when(
    Country == "Iran" ~ "Iran (Islamic Rep. of)", 
    Country == "Hong Kong " ~ "China, Hong Kong SAR",
    TRUE ~ Country
  )) %>%
  filter(Country %in% all_comp_farms$Country) %>%
  group_by(Country) %>%
  summarise(n_obs = sum(`Number of farms`), 
            n_species = n(),
            tonnes = sum(`Tonnes of production`)) %>%
  filter(!is.na(n_obs)) 

sum(comp_across_all$tonnes, na.rm = TRUE) # account for 4328484 tonnes of production 

4328484/29623515 # these account for ~15% of included production tonnage

## these are the countries that are comprehensive across all species groups they report
cat(comp_across_all$Country, sep = ", ")


```


Score the different taxa maps for the global food paper: 


Score | Spatial Extent | Spatial Resolution | Temporal specificity | System specificity | System comprehensiveness
-- | -- | -- | -- | -- | --
5 | Represents entire spatial extent of the food system. | <= 5 arc minutes | Data is specific to 2017 | The data is reported to the level of our specific food type (e.g. cow mixed milk) | Data represents all foods within a system
4 | Need to gapfill regions with relatively little production (e.g. Aland islands) | sub-national or raster with cells larger than 5-arc minutes | Data range includes 2017 and is likely to represent 2017 | Generalized to animal type, but not both rearing system or product (e.g. cows mixed) | Data represents majority of foods within a system
3 | Need to gapfill countries with considerable production (e.g. Philippines) | National | Data range doesn't include 2017 and is likely to represent 2017. | Generalized to animal type, but not rearing system or product (e.g. cows) | Data represents half of foods within a system
2 | Need to gapfill whole continents/georegions | Georegions | Data range includes 2017 and is unlikely to represent 2017 | Generalized to multiple animal types (e.g. cattle/ungulates) | Data represents minority of foods within a system
1 | Generalized globally using site-level data. | Global/generalized | Data is older than 2017 and is unlikely to represent 2017 | Data is generalized across major food system (e.g. all reared animals) | Data represents minimum of foods within a system
NA | Spatial extent is not relevant | Spatial resolution of the data is not relevant | Age of data isn't relevant | Data is not specific to a food system | Data is not specific to a food system


**Salmonids farms map quality**
 - Spatial extent: 4
 - Spatial resolution: 5
 - Temporal specificity: 4
 - System specificity: 2
 - System comprehensiveness: 4
 
 
**Tuna farms map quality**
 - Spatial extent: 5
 - Spatial resolution: 5
 - Temporal specificity: 4
 - System specificity: 3
 - System comprehensiveness: 5
 
 
**Shrimp farms map quality**
 - Spatial extent: 2
 - Spatial resolution: 5
 - Temporal specificity: 4
 - System specificity: 2
 - System comprehensiveness: 4
 
 
**General marine fish farms map quality**
 - Spatial extent: 2
 - Spatial resolution: 5
 - Temporal specificity: 4
 - System specificity: 1
 - System comprehensiveness: 4
 
 
**Unfed or algae fed shellfish farms map quality**
 - Spatial extent: 2
 - Spatial resolution: 5
 - Temporal specificity: 4
 - System specificity: 2
 - System comprehensiveness: 4
 
 
**Other crustaceans farms map quality**
 - Spatial extent: 1
 - Spatial resolution: 1
 - Temporal specificity: NA
 - System specificity: 1
 - System comprehensiveness: 4
 
 
 



Some random exploring
```{r}
by_type <- all_farms %>%
  group_by(species) %>%
  summarise(n_obs = n())  


by_country_type <- all_farms %>%
  group_by(iso3c, species) %>%
  summarise(n_obs = n()) %>%
  left_join(sources) %>%
  dplyr::select(iso3c, species, n_obs, number_of_total_farms) %>%
  mutate(difference = n_obs - number_of_total_farms)


by_data_type_country <- all_farms %>%
  group_by(iso3c, species, data_type) %>%
  summarise(n_obs = n()) %>%
  ungroup() %>%
  left_join(sources) %>%
  dplyr::select(iso3c, species, data_type, n_obs, number_of_total_farms, known_farms_location, known_farms_no_location, estimated_farms)

known <- by_data_type_country %>%
  filter(data_type == "known location") %>%
  dplyr::select(iso3c, species, data_type, n_obs, known_farms_location) %>%
  mutate(difference = n_obs - known_farms_location)

number_known <- by_data_type_country %>% 
  filter(data_type == "modeled location, known number of farms") %>%
  dplyr::select(iso3c, species, data_type, n_obs, known_farms_no_location) %>%
  mutate(difference = n_obs - known_farms_no_location)

estimated <- by_data_type_country %>% 
  filter(data_type == "modeled location, estimated number of farms") %>%
  dplyr::select(iso3c, species, data_type, n_obs, estimated_farms) %>%
  mutate(difference = n_obs - estimated_farms)

```
