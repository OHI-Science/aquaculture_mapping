---
title: "Summary stats for paper"
author: "Gage Clawson (UCSB, NCEAS, OHI)"
date: "04/26/2021"
output: html_document
editor_options: 
  chunk_output_type: console
---

This script takes our final farms dataset and calculates summary statistics that will be used in the paper. 

```{r}

library(here)
library(dplyr)
library(sf)
library(raster)
library(mapview)
library(tidyverse)
library(RCurl)
library(mosaic)
library(googlesheets4)
library(janitor)
library(countrycode)

source(here("_spatial/template_raster.R"))

path <- "/home/shares/food-systems/Food_footprint/_raw_data/Aquaculture_locations"

```



# Read in farms data

```{r}

all_farms <- read_csv("all_marine_aquaculture_farms_sources_31km.csv")

all_farms_sf <- all_farms %>%
  st_as_sf(coords =c("X", "Y")) 

```


```{r}
sources <- read_csv("analysis/data/mariculture_mapping_sources.csv") %>%
  clean_names() %>%
  mutate(type = case_when(species == "Salmonids" ~ "salmon",
                          species == "Unfed or algae fed shellfish" ~ "bivalve",
                          species == "Shrimp" ~ "shrimp",
                          species == "Tuna" ~ "tuna",
                          species == "General Marine Fish" ~ "marine_fish_general",
                          species == "Crustaceans" ~ "crustaceans"))


## Numbers by data type
by_data_type <- all_farms %>%
  group_by(data_type) %>%
  summarise(n_obs = n()) %>%
  mutate(total_obs = sum(n_obs)) %>% 
  ungroup() %>%
  mutate(pct = n_obs/total_obs*100)

by_data_type
# A tibble: 3 x 4
#   data_type                                   n_obs total_obs   pct
#   <chr>                                       <int>     <int> <dbl>
# 1 known location                               9750     95341  10.2
# 2 modeled location, estimated number of farms 75073     95341  78.7
# 3 modeled location, known number of farms     10519     95341  11.0

# How many countries have spatial locations information?
known_countries <- all_farms %>%
  filter(data_type == "known location") %>%
  distinct(iso3c)


# China represented 61% of all farms (N=58,166), but only 15 had known locations.

chn_data_estimated <- all_farms %>%
  filter(iso3c == "CHN") 
# 58166 points
58166/95342 # 0.6099201 = 61%


chn_data_known <- all_farms %>%
  filter(iso3c == "CHN") %>%
  filter(data_type == "known location") # 15 locations 

# Chile, Norway, and Ireland provided a substantial number of known locations (>1000).
top_known <- all_farms %>%
  filter(data_type == "known location") %>%
  group_by(iso3c) %>%
    summarise(n_obs = n())


# Only 5 countries (Cambodia, Mauritius, Myanmar, North Korea, and Russia) had no form of farm data at all, however, these countries only account for 0.5% of marine aquaculture production included.

no_info <- all_farms %>%
  group_by(iso3c) %>%
  mutate(check = all(data_type_2 == "F")) %>%
  filter(check == TRUE) 
unique(no_info$country)

# [1] "Cambodia"                              "Myanmar"                              
# [3] "Mauritius"                             "Democratic People’s Republic of Korea"
# [5] "Russian Federation" 


mar_production <- read_csv("marine/STEP1_species_groups/int/tonnes_per_country_group.csv")

sum(no_info$tonnes_per_farm) # 155205.1

sum(mar_production$total_tonnes) # 29623515

155205.1/29623515 # 0.005239253

chn_production <- mar_production %>%
  filter(country == "China")
sum(chn_production$total_tonnes)
17696822/29623515 # 0.597391

# Per species group, salmon was the most data rich (98% of points had location information, 1.13% of points were known with no location information, 0.87% estimated), followed by Tuna (34% of points had location information, 66% of points were known with no location information, 0% estimated).


by_species_data_type <- all_farms %>%
  group_by(species_group, data_type) %>%
  summarise(n_obs = n()) %>%
  mutate(total_obs = sum(n_obs)) %>% 
  ungroup() %>%
  mutate(pct = n_obs/total_obs*100)



## How much fish and invertebrate mariculture production was included in our assessment? 

fao <- read_csv("data/fao_aquaculture_clean.csv")
mar_sp_list <- read_csv("https://raw.githubusercontent.com/OHI-Science/ohiprep_v2020/gh-pages/globalprep/mar/v2020/raw/species_list.csv")

fw <- fao %>%
  dplyr::filter(environment == "Freshwater") %>%
  group_by(species) %>%
  summarize(total = sum(value)) %>%
  ungroup() %>%
  arrange(total)

data.frame(fw)

test <- fao %>%
  filter(year == 2017) %>%
  left_join(mar_sp_list, by = c("species" = "FAO_name")) %>%
  mutate(environment2 = ifelse(Taxon_code == "AL", "seaweed", environment)) %>%
  mutate(environment = ifelse(is.na(environment2), environment, environment2)) %>%
  filter(environment != "Freshwater") %>%
  group_by(environment, year) %>%
  summarise(prod = sum(value, na.rm = TRUE)) %>%
  ungroup() %>%
  mutate(total = sum(prod)) %>%
  mutate(pct = prod/total)

## total fish and invertebrate mariculture production is: 8090542 + 22920871 = 31011413

## we include: 29623515
prod_total <- read_csv("/home/shares/food-systems/Food_footprint/all_food_systems/dataprep/aquaculture/marine/production_extracted_final.csv")

sum(prod_total$total_tonnes) # 29623515

29623515/31011413 # 0.9552456
```


Countries with comprehensive farm locations 

However, 16 countries (representing 10% of fish and invertebrate mariculture production) had comprehensive farm locations across all taxa (i.e. no estimation or interpolation required, Table S3)
```{r}

all_comp <- all_farms %>%
  group_by(iso3c) %>%
  mutate(check = all(data_type_2 == "A")) %>%
  filter(check == TRUE) 

sort(unique(all_comp$country))

print(unique(all_comp$country))

cat(paste(sort(unique(all_comp$country)), collapse= "', '"))

# Belize, Bulgaria, Canada, Chile, Cyprus, Denmark, Faroe Islands, Finland, French Polynesia, Greece, Hong Kong , Ireland, Jersey, Malta, Norway, United Arab Emirates, United Kingdom

## how much production do they account for? 

mar_production <- read_csv("marine/STEP1_species_groups/int/tonnes_per_country_group.csv")

comp_prod <- mar_production %>%
  filter(country %in% c('Belize', 'Bulgaria', 'Canada', 'Chile', 'Cyprus', 'Denmark', 'Faroe Islands', 'Finland', 'French Polynesia', 'Greece', 'China, Hong Kong SAR', 'Ireland', 'Jersey', 'Malta', 'Norway', 'United Arab Emirates', 'United Kingdom'))

sum(comp_prod$total_tonnes) # 3203584

3203584/31011413 # 0.1033034 ~ 10%

```

Countries with comprehensive "number of farm" information

"Thirty-six of the countries in the table have comprehensive “number of farm” data across all types of mariculture they produce (data types A, B, or C), accounting for 12% of the global fish and invertebrate mariculture production (Albania, Belize, Bulgaria, Canada, Chile, Colombia, Croatia, Cyprus, Denmark, El Salvador, Faroe Islands, Finland, French Polynesia, Germany, Greece, Guatemala, Guernsey, Hong Kong, Ireland, Italy, Jersey, Madagascar, Malta, Netherlands, New Zealand, Norway, Peru, Portugal, Singapore, Slovenia, South Africa, Sri Lanka, Tunisia, Turkey, United Arab Emirates, United Kingdom)."

```{r}

all_comp <- all_farms %>%
  group_by(iso3c) %>%
  mutate(check = all(data_type_2 %in% c("A", "B", "C"))) %>%
  filter(check == TRUE)
sort(unique(all_comp$country))

cat(paste(sort(unique(all_comp$country)), collapse= "', '"))

# Albania', 'Belize', 'Bulgaria', 'Canada', 'Chile', 'Colombia', 'Croatia', 'Cyprus', 'Denmark', 'El Salvador ', 'Faroe Islands', 'Finland', 'French Polynesia', 'Germany', 'Greece', 'Guatemala', 'Guernsey', 'Hong Kong ', 'Ireland', 'Italy', 'Jersey', 'Madagascar', 'Malta', 'Netherlands', 'New Zealand', 'Norway', 'Peru', 'Portugal', 'Singapore', 'Slovenia', 'South Africa', 'Sri Lanka', 'Tunisia', 'Turkey', 'United Arab Emirates', 'United Kingdom

## how much production do they account for? 

mar_production <- read_csv("marine/STEP1_species_groups/int/tonnes_per_country_group.csv")

comp_prod <- mar_production %>%
  filter(country %in% c('Albania', 'Belize', 'Bulgaria', 'Canada', 'Chile', 'Colombia', 'Croatia', 'Cyprus', 'Denmark', 'El Salvador ', 'Faroe Islands', 'Finland', 'French Polynesia', 'Germany', 'Greece', 'Guatemala', 'Guernsey', 'Hong Kong ', 'Ireland', 'Italy', 'Jersey', 'Madagascar', 'Malta', 'Netherlands', 'New Zealand', 'Norway', 'Peru', 'Portugal', 'Singapore', 'Slovenia', 'South Africa', 'Sri Lanka', 'Tunisia', 'Turkey', 'United Arab Emirates', 'United Kingdom'))

sum(comp_prod$total_tonnes) # 3788091

3788091/31011413 # 0.1221515 ~ 10%


```


Using the country/species grouping combinations with presumed comprehensive farm count data (N=74, 17% of production included, data type A/B/C, see Table S3)
```{r}

test <- all_farms %>%
  filter(data_type_2 %in% c("A", "B", "C")) %>%
  group_by(country, species_group) 

cat(paste(sort(unique(test$country)), collapse= "', '"))

sum(test$tonnes_per_farm)
 
4963244/29623515 # 0.1675441 ~ 17%

```




Score the different taxa maps for the global food paper: 


Score | Spatial Extent | Spatial Resolution | Temporal specificity | System specificity | System comprehensiveness
-- | -- | -- | -- | -- | --
5 | Represents entire spatial extent of the food system. | <= 5 arc minutes | Data is specific to 2017 | The data is reported to the level of our specific food type (e.g. cow mixed milk) | Data represents all foods within a system
4 | Need to gapfill regions with relatively little production (e.g. Aland islands) | sub-national or raster with cells larger than 5-arc minutes | Data range includes 2017 and is likely to represent 2017 | Generalized to animal type, but not both rearing system or product (e.g. cows mixed) | Data represents majority of foods within a system
3 | Need to gapfill countries with considerable production (e.g. Philippines) | National | Data range doesn't include 2017 and is likely to represent 2017. | Generalized to animal type, but not rearing system or product (e.g. cows) | Data represents half of foods within a system
2 | Need to gapfill whole continents/georegions | Georegions | Data range includes 2017 and is unlikely to represent 2017 | Generalized to multiple animal types (e.g. cattle/ungulates) | Data represents minority of foods within a system
1 | Generalized globally using site-level data. | Global/generalized | Data is older than 2017 and is unlikely to represent 2017 | Data is generalized across major food system (e.g. all reared animals) | Data represents minimum of foods within a system
NA | Spatial extent is not relevant | Spatial resolution of the data is not relevant | Age of data isn't relevant | Data is not specific to a food system | Data is not specific to a food system


**Salmonids farms map quality**
 - Spatial extent: 4
 - Spatial resolution: 5
 - Temporal specificity: 4
 - System specificity: 2
 - System comprehensiveness: 4
 
 
**Tuna farms map quality**
 - Spatial extent: 5
 - Spatial resolution: 5
 - Temporal specificity: 4
 - System specificity: 3
 - System comprehensiveness: 5
 
 
**Shrimp farms map quality**
 - Spatial extent: 2
 - Spatial resolution: 5
 - Temporal specificity: 4
 - System specificity: 2
 - System comprehensiveness: 4
 
 
**General marine fish farms map quality**
 - Spatial extent: 2
 - Spatial resolution: 5
 - Temporal specificity: 4
 - System specificity: 1
 - System comprehensiveness: 4
 
 
**Unfed or algae fed shellfish farms map quality**
 - Spatial extent: 2
 - Spatial resolution: 5
 - Temporal specificity: 4
 - System specificity: 2
 - System comprehensiveness: 4
 
 
**Other crustaceans farms map quality**
 - Spatial extent: 1
 - Spatial resolution: 1
 - Temporal specificity: NA
 - System specificity: 1
 - System comprehensiveness: 4
 
