---
title: "Match point to sources"
author: "Gage Clawson (UCSB, NCEAS, OHI)"
date: "04/26/2021"
output: html_document
editor_options: 
  chunk_output_type: console
---

This script takes the farms dataset produced from prior steps, and matches to our data source spreadsheet (created manually in our literature review), so that each point in the final database has a source associated with it (or an NA, if it was estimated). 

```{r}

library(here)
library(dplyr)
library(sf)
library(raster)
library(mapview)
library(tidyverse)
library(RCurl)
library(mosaic)
library(googlesheets4)
library(janitor)

source(here("_spatial/template_raster.R"))

path <- "/home/shares/food-systems/Food_footprint/_raw_data/Aquaculture_locations"

```


# Global regions

```{r}

# this file includes ocean regions:
gadm <- raster("/home/shares/food-systems/Food_footprint/_raw_data/Country_regions/gadm36mol_pyfill_10km.tif")

gadm_latlon <- raster::projectRaster(gadm, food_raster, method="ngb", over=TRUE)
# plot(gadm_latlon)

gadm_codes <- read.csv("/home/shares/food-systems/Food_footprint/_raw_data/Country_regions/gadm_reg_codes.csv") %>% 
  mutate(reg_id = as.numeric(reg_id))

```

# read in points and convert to spatial dataframe
```{r}


library(readxl)    
read_excel_allsheets <- function(filename, tibble = FALSE) {
    # I prefer straight data.frames
    # but if you like tidyverse tibbles (the default with read_excel)
    # then just pass tibble = TRUE
    sheets <- readxl::excel_sheets(filename)
    x <- lapply(sheets, function(X) readxl::read_excel(filename, sheet = X))
    if(!tibble) x <- lapply(x, as.data.frame)
    names(x) <- sheets
    x
}

data <- read_excel_allsheets("analysis/data/mariculture_mapping_sources_raw.xlsx")

df <- plyr::ldply(data, as.data.frame) %>%
  mutate(`Data year: farm locations` = as.character(`Data year: farm locations`),
         `Data year: number of farms` = as.character(`Data year: number of farms`))

data <- read_csv(file.path("marine/output/all_marine_farms.csv")) %>% 
  st_as_sf(., 
           coords = c("lon", "lat"),
           crs = crs(food_raster), 
           agr = "constant")  

all_farms_to_place <- read_csv(file.path("marine/output/all_points_to_add.csv")) %>%
  distinct(iso3c, type, estimated)

all_farms <- readRDS("data/all_modeled_marine_farms_final.rds") %>%
  left_join(all_farms_to_place) %>%
    mutate(data_type = case_when(
    source == "real" ~ "known locations", 
    source == "modeled" & estimated == 0 ~ "modeled locations, known number of farms",
    source == "modeled" & estimated == 1 ~ "modeled locations, estimated number of farms"
  )) %>%
  mutate(estimated = ifelse(is.na(estimated), 0, estimated))

summary(all_farms)

test <- all_farms %>%
  st_drop_geometry() %>%
  group_by(data_type) %>% 
  summarise(n()) ## perfect!! 

test <- all_farms %>%
  dplyr::filter(is.na(estimated))

```

# Match to our sources dataset 
```{r}

# read in our sources spreadsheet (manually uploaded by GC)
sources <- df %>%
  clean_names() %>%
  mutate(type = case_when(species == "Salmonids" ~ "salmon",
                          species == "Unfed or algae fed shellfish" ~ "bivalve",
                          species == "Shrimp" ~ "shrimp", 
                          species == "Tuna" ~ "tuna", 
                          species == "General Marine Fish" ~ "marine_fish_general", 
                          species == "Crustaceans" ~ "crustaceans")) %>%
mutate(species_group = case_when(species == "Salmonids" ~ "Salmonidae fish",
                          species == "Unfed or algae fed shellfish" ~ "Unfed or algae fed bivalve molluscs",
                          species == "Shrimp" ~ "Shrimps and prawns", 
                          species == "Tuna" ~ "Bluefin tuna", 
                          species == "General Marine Fish" ~ "General marine fish", 
                          species == "Crustaceans" ~ "Non-shrimp crustaceans")) %>% 
  mutate(data_year_number_of_farms = as.character(data_year_number_of_farms)) %>%
 # mutate(estimated_farms = ifelse(is.na(estimated_farms), estimated_farms_2, estimated_farms)) %>%
  dplyr::select(-id) %>%
  mutate(data_type_2 = case_when(
    known_farms_location > 0 & known_farms_no_location == 0 & estimated_farms == 0 ~ "A",
    known_farms_location == 0 & known_farms_no_location > 0 & estimated_farms == 0 ~ "B",
    known_farms_location > 0 & known_farms_no_location > 0 & estimated_farms == 0 ~ "C",
    known_farms_location > 0 & known_farms_no_location == 0 & estimated_farms > 0 ~ "D",
    known_farms_location == 0 & known_farms_no_location == 0 & estimated_farms > 0 ~ "F",
  )) %>%
  mutate(data_type_2 = ifelse(str_detect(details, "Although"), "D", data_type_2)) %>%
  mutate(data_type_2 = ifelse(iso3c == "IND" & species == "Unfed or algae fed shellfish", "E", data_type_2)) ## fix some mismatches


## data types with comprehensive # of farms are A, B, and C. These all receive their production/# of farms to get prod per farm. 

## data types D, E, and F receive global prod per farm estimates. 

## read in all species production 

biv_prod <- read_csv("marine/bivalve/bivalve_farms/data/fao_mariculture_bivalve.csv") %>%
  mutate(type = "bivalve")
crust_prod <- read_csv("marine/crustaceans/crustaceans_farms/data/fao_mariculture_crustaceans.csv") %>%
  mutate(type = "crustaceans")
finfish_prod <- read_csv("marine/marine_fish_general/finfish_farms/data/fao_mariculture_finfish.csv") %>%
  mutate(type = "marine_fish_general")
salmon_prod <- read_csv("marine/salmon/salmon_farms/data/fao_mariculture_salmon.csv") %>%
  mutate(type = "salmon")
shrimp_prod <- read_csv("marine/shrimp/shrimp_farms/data/fao_mariculture_shrimp.csv") %>%
  mutate(type = "shrimp")
tuna_prod <- read_csv("marine/tuna/tuna_farms/data/fao_mariculture_tuna.csv") %>%
  mutate(type = "tuna")

all_prod <- rbind(biv_prod, crust_prod, finfish_prod, salmon_prod, shrimp_prod, tuna_prod) %>%
  filter(year == 2017)

spp_prod_per_farm <- read_csv("analysis/data/prod_per_farm.csv")

sources_prod <- sources %>%
  left_join(all_prod, by = c("iso3c", "type")) %>%
  left_join(spp_prod_per_farm) %>% 
  mutate(tonnes_per_farm = case_when(
        str_detect(details, "Although") ~ fao_tonnes_production/number_of_total_farms,
    data_type_2 %in% c("A", "B", "C") ~ fao_tonnes_production/number_of_total_farms,
    data_type_2 %in% c("D", "F") ~ spp_prod_per_farm,
    data_type_2 %in% c("E") ~ fao_tonnes_production/number_of_total_farms  )) %>%
  dplyr::select(-country.y, -spp_prod_per_farm) %>%
  rename("country" = "country.x")

sources_prod_SI_table <- sources_prod %>%
  dplyr::select(country, species_group, fao_tonnes_production, number_of_total_farms, tonnes_per_farm, data_type_2) %>%
  arrange(country)

write.csv(sources_prod_SI_table, "analysis/tables/SI_table_3.csv", row.names = FALSE)




## join all farms with sources data 
all_farms_sources <- all_farms %>%
  left_join(sources_prod, by = c("iso3c", "type")) %>%
  mutate(data_source = case_when(
    data_type == "modeled locations, known number of farms" ~ datasource_number_of_farms,
    data_type == "modeled locations, estimated number of farms" ~ "NA", 
    data_type == "known locations" ~ datasource_farm_locations), 
  data_year = case_when(
    data_type == "modeled locations, known number of farms" ~ data_year_number_of_farms,
    data_type == "modeled locations, estimated number of farms" ~ "NA", 
    data_type == "known locations" ~ data_year_farm_locations)) %>%
  dplyr::select(iso3c, country, species_group, species, data_type, data_type_2, details, data_source, data_year, tonnes_per_farm, geometry) 

unique(all_farms_sources$data_year)

test <- all_farms_sources %>%
  filter(iso3c == "CHN", 
         species_group == "Shrimps and prawns")

## will need to fix china bivalve and shrimp

sum(all_farms_sources$tonnes_per_farm) # 29639681
sum(all_prod$fao_tonnes_production) # 29623515

29623515 - 29639681 # off by about 16k.. probably because of rounding issues 
```


# Fix instances where a known location has multiple sources
```{r}
test <- all_farms_sources %>%
  filter(iso3c == "AUS", species == "Unfed or algae fed shellfish")
unique(all_farms_sources$species)

test <- all_farms_sources %>%
  filter(iso3c == "IND", species == "Unfed or algae fed shellfish")


## Have multiple location data sources...  fix these so that each point has only one of the datasources 

# Salmon: CAN, USA
# Shrimp: USA, CHN 
# Bivalve: AUS, CAN, USA, CHN
# General marine fish: TWN

## add in subregional information
all_farms_sources_gadm <- all_farms_sources
all_farms_sources_gadm$reg_id <- raster::extract(gadm_latlon, all_farms_sources) 

all_farms_sources_gadm <- all_farms_sources_gadm %>%
  left_join(gadm_codes, by="reg_id") %>%
  dplyr::mutate(NAME_1 = as.character(NAME_1)) 

## Canada Salmon fix: 
CAN_salmon_fix <- all_farms_sources_gadm %>%
  dplyr::filter(iso3c == "CAN", 
               species == "Salmonids") %>%
  separate(col = data_source, into = c("ds_1", "ds_2", "ds_3", "ds_4"), sep = ";") %>%
  separate(col = data_year, into = c("dy_1", "dy_2", "dy_3", "dy_4"), sep = ",") %>%
  mutate(data_source = case_when(
    NAME_1 == "British Columbia" ~ ds_1, 
    NAME_1 %in% c("New Brunswick", "Maine") ~ ds_2, 
    NAME_1 %in% c("Newfoundland and Labrador") ~ ds_4,
    NAME_1 == "Nova Scotia" ~ ds_3
    
  )) %>%
  mutate(data_year = case_when(
    NAME_1 == "British Columbia" ~ dy_1, 
    NAME_1 %in% c("New Brunswick", "Maine") ~ dy_2, 
    NAME_1 %in% c("Newfoundland and Labrador") ~ dy_4,
    NAME_1 == "Nova Scotia" ~ dy_3
    
  )) %>%
  dplyr::select(iso3c, country, species_group, species, data_type, data_type_2, tonnes_per_farm, details, data_source, data_year, geometry)

check <- CAN_salmon_fix %>%
  st_drop_geometry() %>%
  group_by(data_source) %>%
  summarise(n()) ## numbers are correct


## Canada Bivalve fix: 
CAN_bivalve_fix <- all_farms_sources_gadm %>%
  dplyr::filter(iso3c == "CAN", 
               species == "Unfed or algae fed shellfish") %>%
  separate(col = data_source, into = c("ds_1", "ds_2"), sep = ";") %>%
  mutate(data_source = case_when(
    NAME_1 == "British Columbia" ~ ds_1, 
    NAME_1 == "Nova Scotia" ~ ds_2
    
  )) %>%
  dplyr::select(iso3c, country, species_group, species, data_type, data_type_2, tonnes_per_farm, details, data_source, data_year, geometry)

check <- CAN_bivalve_fix %>%
  st_drop_geometry() %>%
  group_by(data_source) %>%
  summarise(n()) ## numbers are correct


## USA Salmon fix: 
USA_salmon_fix <- all_farms_sources_gadm %>%
  dplyr::filter(iso3c == "USA", 
               species == "Salmonids") %>%
  separate(col = data_source, into = c("ds_1", "ds_2"), sep = ";") %>%
  separate(col = data_year, into = c("dy_1", "dy_2"), sep = ",") %>%
  mutate(data_source = case_when(
    NAME_1 %in% c("New Brunswick", "Maine") ~ ds_2, 
    NAME_1 == "Washington" ~ ds_1
  )) %>%
    mutate(data_year = case_when(
    NAME_1 %in% c("New Brunswick", "Maine") ~ dy_2, 
    NAME_1 == "Washington" ~ dy_1
  )) %>%
  dplyr::select(iso3c, country, species_group, species, data_type, data_type_2, tonnes_per_farm, details, data_source, data_year, geometry)

check <- USA_salmon_fix %>%
  st_drop_geometry() %>%
  group_by(data_source) %>%
  summarise(n()) ## numbers are correct


## USA Shrimp fix: 
USA_shrimp_fix <- all_farms_sources_gadm %>%
  dplyr::filter(iso3c == "USA", 
               species == "Shrimp") %>%
  separate(col = data_source, into = c("ds_1", "ds_2", "ds_3", "ds_4", "ds_5"), sep = ";") %>%
  separate(col = data_year, into = c("dy_1", "dy_2"), sep = ",") %>%
  mutate(data_source = case_when(
    NAME_1 %in% c("Texas") ~ ds_2, 
    NAME_1 == "Alabama" ~ ds_3, 
    NAME_1 == "Hawaii" ~ ds_4, 
    NAME_1 == "Florida" ~ ds_5
  )) %>%
    mutate(data_year = case_when(
    NAME_1 %in% c("Texas") ~ dy_1, 
    NAME_1 == "Alabama" ~ dy_2, 
    NAME_1 == "Hawaii" ~ dy_2, 
    NAME_1 == "Florida" ~ dy_2
  )) %>%
  dplyr::select(iso3c, country, species_group, species, data_type, data_type_2, tonnes_per_farm, details, data_source, data_year, geometry)


## USA Bivalve fix: 
USA_bivalve_fix <- all_farms_sources_gadm %>%
  dplyr::filter(iso3c == "USA", 
               species == "Unfed or algae fed shellfish", 
               data_type == "known locations") %>%
  separate(col = data_source, into = c("ds_1", "ds_2"), sep = ";") %>%
  mutate(data_source = ifelse(NAME_1 == "Washington"| NAME_1 == "Rhode Island", ds_2, ds_1)) %>% 
  mutate(data_year = 2018) %>%
  dplyr::select(iso3c, country, species_group, species, data_type, data_type_2, tonnes_per_farm, details, data_source, data_year, geometry)

check <- USA_bivalve_fix %>%
  st_drop_geometry() %>%
  group_by(data_source) %>%
  summarise(n()) ## numbers are correct

## AUS Bivalve fix: 
AUS_bivalve_fix <- all_farms_sources_gadm %>%
  dplyr::filter(iso3c == "AUS", 
               species == "Unfed or algae fed shellfish", 
               data_type == "known locations") %>%
  separate(col = data_source, into = c("ds_1", "ds_2"), sep = ";") %>%
  mutate(data_source = ifelse(NAME_1 == "Victoria", ds_1, ds_2)) %>%
  mutate(data_year = 2021) %>%
  dplyr::select(iso3c, country, species_group, species, data_type, data_type_2, tonnes_per_farm, details, data_source, data_year, geometry)


## TWN marine fish fix: 
# read in taiwan sources sheet
twn_sources <- read_csv(here("marine/marine_fish_general/finfish_farms/data/taiwan_farms_sources.csv"))

twn_sources_sf <- st_as_sf(twn_sources, coords = c("lon", "lat"), 
                 crs = crs(gadm_latlon), agr = "constant")

## rows 1-40 are lee, rows 41-66 are kuo
TWN_finfish_fix <- all_farms_sources_gadm %>%
  dplyr::filter(iso3c == "TWN", 
               species == "General Marine Fish", 
               data_type == "known locations") %>%
  separate(col = data_source, into = c("ds_1", "ds_2"), sep = ";") %>% 
  separate(col = data_year, into = c("dy_1", "dy_2"), sep = ",") %>% 
  mutate(row = row_number()) %>%
  mutate(data_source = ifelse(row %in% c(1:40), ds_1, ds_2)) %>%
  mutate(data_year = ifelse(row %in% c(1:40), dy_1, dy_2)) %>%
  dplyr::select(iso3c, country, species_group, species, data_type, data_type_2, tonnes_per_farm, details, data_source, data_year, geometry)


## China bivalve fix
### There are 11 farms from ASC... 


# read in ASC dataset for China bivalves
farms_chn <- read.csv(here("marine/bivalve/bivalve_farms/data/ASC_bivalve_farm_lat_lon.csv")) %>%
  dplyr::filter(iso3c == "CHN") %>%
  mutate(data_quality = 2)

## so it looks like the first 11 rows are the ASC rows.. the geometries are not as precise 
CHN_bivalve_fix <- all_farms_sources_gadm %>%
  dplyr::filter(iso3c == "CHN", 
               species == "Unfed or algae fed shellfish", 
               data_type == "known locations") %>%
  separate(col = data_source, into = c("ds_1", "ds_2"), sep = ";") %>%
  mutate(row = row_number()) %>%
  mutate(data_source = ifelse(row %in% c(1:11), ds_1, ds_2)) %>%
  mutate(data_year = 2021) %>%
  dplyr::select(iso3c, country, species_group, species, data_type, data_type_2, tonnes_per_farm, details, data_source, data_year, geometry)

## do the same for China shrimp

farms_chn <- read.csv(here("marine/shrimp/shrimp_farms/data/ASC_shrimp_farm_lat_lon.csv")) %>%
  dplyr::filter(iso3c == "CHN") %>%
  mutate(data_quality = 2)

## so it looks like the first 4 rows are the ASC rows.. the geometries are not as precise 
CHN_shrimp_fix <- all_farms_sources_gadm %>%
  dplyr::filter(iso3c == "CHN", 
               species == "Shrimp", 
               data_type == "known locations") %>%
  separate(col = data_source, into = c("ds_1", "ds_2"), sep = ";") %>%
  mutate(row = row_number()) %>%
  mutate(data_source = ifelse(row %in% c(1:4), ds_1, ds_2)) %>%
  mutate(data_year = 2021) %>%
  dplyr::select(iso3c, country, species_group, species, data_type, data_type_2, tonnes_per_farm, details, data_source, data_year, geometry)

##### Now add these back into total dataset ##### 

all_farms_sources_final <- all_farms_sources %>%
  filter(iso3c != "CAN"|species != "Salmonids") %>%
  filter(iso3c != "CAN"|species != "Unfed or algae fed shellfish") %>%
  filter(iso3c != "USA"|species != "Salmonids") %>%
  filter(iso3c != "USA"|species != "Unfed or algae fed shellfish"|data_type != "known locations") %>%
  filter(iso3c != "AUS"|species != "Unfed or algae fed shellfish"|data_type != "known locations") %>%
  filter(iso3c != "TWN"|species != "General Marine Fish"|data_type != "known locations") %>%
  filter(iso3c != "USA"|species != "Shrimp") %>%
  filter(iso3c != "CHN"|species != "Unfed or algae fed shellfish"|data_type != "known locations") %>%
  filter(iso3c != "CHN"|species != "Shrimp"|data_type != "known locations") %>%
  rbind(TWN_finfish_fix, USA_bivalve_fix, USA_salmon_fix, USA_shrimp_fix, CAN_bivalve_fix, CAN_salmon_fix, AUS_bivalve_fix, CHN_bivalve_fix, CHN_shrimp_fix) %>%
  mutate(data_year = as.numeric(data_year)) %>%
  dplyr::select(-species)

summary(all_farms_sources_final)
unique(all_farms_sources_final$data_year)
unique(sort(all_farms_sources$country))
unique(sort(all_farms_sources$iso3c)) ## 73 countries - perfect! 
unique(all_farms_sources_final$species_group)
sum(all_farms_sources_final$tonnes_per_farm) # 29639681

## Now save this as a csv
st_write(all_farms_sources_final, "data/all_marine_aquaculture_farms_sources_final.csv", layer_options = "GEOMETRY=AS_XY", delete_dsn = TRUE)

## check that it wrote correctly

all_farms <- read_csv("data/all_marine_aquaculture_farms_sources_final.csv")

test <- all_farms %>%
  filter(iso3c == "GBR", str_detect(species_group, "almo")) %>%
    st_as_sf(., 
           coords = c("X", "Y"),
           crs = crs(food_raster), 
           agr = "constant")  

mapview(test)

```


