---
title: "Figures for SI"
author: "Gage Clawson (UCSB, NCEAS, OHI)"
date: "06/14/2021"
output: html_document
editor_options: 
  chunk_output_type: console
---

This script takes our final farms dataset and creates the figures which will be showcased in the SI. 

```{r}

library(here)
library(dplyr)
library(sf)
library(raster)
library(mapview)
library(tidyverse)
library(RCurl)
library("rnaturalearth")
library("rnaturalearthdata")
library(cowplot) 
library(ggpubr)
library(RColorBrewer)
library(OpenStreetMap)
library(ggspatial)
library(ggplot2)
library(patchwork)



source(here("_spatial/template_raster.R"))

path <- "/home/shares/food-systems/Food_footprint/_raw_data/Aquaculture_locations"

```


# Global regions

```{r}

# this file includes ocean regions:
gadm <- raster("/home/shares/food-systems/Food_footprint/_raw_data/Country_regions/gadm36mol_pyfill_10km.tif")

gadm_latlon <- raster::projectRaster(gadm, food_raster, method="ngb", over=TRUE)
# plot(gadm_latlon)

gadm_codes <- read.csv("/home/shares/food-systems/Food_footprint/_raw_data/Country_regions/gadm_reg_codes.csv") %>% 
  mutate(reg_id = as.numeric(reg_id))
```

# Read in farms data and convert to sf

```{r}
all_farms_sf <- read_csv("data/all_marine_aquaculture_farms_sources_final.csv") %>%
    st_as_sf(., 
           coords = c("X", "Y"),
           crs = crs(food_raster), 
           agr = "constant")  

all_farms <- all_farms_sf %>%
  st_drop_geometry()

test <- all_farms_sf %>%
  filter(country == "United States of America")
mapview(test, zcol = "data_type_2") 


test <- all_farms_sf %>%
  filter(iso3c == "MEX")
mapview(test, zcol = "data_type_2") 

test <- all_farms_sf %>%
  filter(iso3c == "HRV")
mapview(test) ## one weird MFG from ASC

test <- all_farms_sf %>%
  filter(iso3c == "TUR")
mapview(test) ## one weird MFG from ASC.. i think these are fine. Justifiable since it is from the ASC...

```



```{r}

all_farms <- read_csv("data/all_marine_aquaculture_farms_sources_final.csv")

unique(sort(all_farms$country))

all_farms_stat <- all_farms %>%
  mutate(lon = round(X, 0), 
         lat = round(Y, 0)) 

lon_stat <- all_farms_stat %>%
  group_by(lon) %>%
  summarise(n())

lat_stat <- all_farms_stat %>%
  group_by(lat) %>%
  summarise(n())

```


## Make the global map by species group (Supplementary Figures 1-6)
```{r}
world <- ne_countries(scale = "medium", returnclass = "sf")
class(world)

# https://stackoverflow.com/questions/8545035/scatterplot-with-marginal-histograms-in-ggplot2

## This one works!


for(i in 1:6){

 # i = 4
  
  spp_group <- unique(all_farms$species_group)[i]
  
  all_farms_i <- all_farms %>%
    filter(species_group == spp_group)
  
  
    count_type_df <- all_farms_i %>%
    group_by(species_group) %>%
    summarise(n=n()) 
  
  count_type <- count_type_df$n
  
    count_green_df <- all_farms_i %>%
    group_by(data_type) %>%
    summarise(n = n()) %>%
    filter(data_type == "known locations")
  
  count_green <- count_green_df$n
  
    
if(is_empty(count_green) == TRUE){
    count_green = 0
  }
    
  count_yellow_df <-  all_farms_i %>%
    group_by(data_type) %>%
    summarise(n = n()) %>%
    filter(data_type == "modeled locations, known number of farms")
  
  count_yellow <- count_yellow_df$n
  
    
if(is_empty(count_yellow) == TRUE){
    count_yellow = 0
  }
    
    
  count_red_df <- all_farms_i %>%
    group_by(data_type) %>%
    summarise(n = n()) %>%
    filter(data_type == "modeled locations, estimated number of farms") 
  
  count_red  <- count_red_df$n
  
if(is_empty(count_red) == TRUE){
    count_red = 0
  }
    
    
    
  
## create first plot
total_map <- ggplot(data = world) +
  geom_sf(fill = "white", lwd = 0.1) + 
  geom_point(data = all_farms_i, aes(x = X, y = Y, col = data_type), size = 0.1, alpha = 0.7) +
  coord_sf(xlim = c(-180, 180), ylim = c(-58, 73), expand = FALSE) +
  scale_x_continuous(breaks = c(-180, -135, -90, -45, 0, 45, 90, 135, 180), position = "top") +
  scale_y_continuous(breaks = c(-90, -45, 0, 45, 90)) + 
  theme_bw() + 
  theme(axis.title.x = element_blank(),
          axis.title.y = element_blank(),
        legend.position = "bottom", 
        legend.title=element_blank(),
        text=element_text(family="Times New Roman"), 
        legend.justification='left',
        legend.direction='horizontal') +
  guides(color = guide_legend(override.aes = list(size = 3, alpha = 0.9), nrow = ifelse(spp_group %in% c("Bluefin tuna", "Non-shrimp crustaceans"), 1, 2))) +
  scale_color_manual(values = c("forestgreen", "orange1", "red3"),
                    breaks = c("known locations", "modeled locations, known number of farms", "modeled locations, estimated number of farms"), labels = c(sprintf("Known locations \n N = %s", count_green), sprintf("Modeled locations, known number of farms \n N = %s", count_yellow), sprintf("Modeled locations, estimated number of farms \n N = %s", count_red)), drop = FALSE) +
  labs(caption = sprintf("%s: N = %s", spp_group, count_type))
  


# total_map


# Create marginal plots
# Use geom_density/histogram for whatever you plotted on x/y axis 
plot_x <- axis_canvas(total_map, axis = "x") +
  geom_histogram(data = all_farms_i, aes(X, fill = data_type), bins = 360)  +
  coord_sf(xlim = c(-180, 180), expand = FALSE) +
  scale_fill_manual(values = c("forestgreen", "orange1", "red3"), 
                    breaks = c("known locations", "modeled locations, known number of farms", "modeled locations, estimated number of farms"), drop = FALSE)

plot_y <- axis_canvas(total_map, axis = "y") +
  geom_histogram(data = all_farms_i, aes(y = Y, fill = data_type), bins = 180, orientation = "y") +
  coord_sf(ylim = c(-58, 73), expand = FALSE) + 
  scale_fill_manual(values = c("forestgreen", "orange1", "red3"), 
                    breaks = c("known locations", "modeled locations, known number of farms", "modeled locations, estimated number of farms"), drop = FALSE)
 # coord_flip() 


# Combine all plots into one
plot_final <- insert_xaxis_grob(total_map, plot_x, position = "top")
plot_final <- insert_yaxis_grob(plot_final, plot_y, position = "right") 
ggdraw(plot_final)

ggsave(sprintf("analysis/si_figs/supp_map_fig_%s.jpg", spp_group))
}

```


## Make the global map by data type 2 (A,B,C,D,E,F) (Supplementary Figures 7-12)


```{r}
world <- ne_countries(scale = "medium", returnclass = "sf")
class(world)

# https://stackoverflow.com/questions/8545035/scatterplot-with-marginal-histograms-in-ggplot2

## This one works!


for(i in c(1:6)){

 # i = 1
  
  data_type_2_id <- unique(all_farms$data_type_2)[i]
  
  all_farms_i <- all_farms %>%
    filter(data_type_2 == data_type_2_id)
  
  count_type_df <- all_farms_i %>%
    group_by(data_type_2) %>%
    summarise(n=n()) 
  
  count_type <- count_type_df$n
  
    count_green_df <- all_farms_i %>%
    group_by(data_type) %>%
    summarise(n = n()) %>%
    filter(data_type == "known locations")
  
  count_green <- count_green_df$n
  
    
if(is_empty(count_green) == TRUE){
    count_green = 0
  }
    
  count_yellow_df <-  all_farms_i %>%
    group_by(data_type) %>%
    summarise(n = n()) %>%
    filter(data_type == "modeled locations, known number of farms")
  
  count_yellow <- count_yellow_df$n
  
    
if(is_empty(count_yellow) == TRUE){
    count_yellow = 0
  }
    
    
  count_red_df <- all_farms_i %>%
    group_by(data_type) %>%
    summarise(n = n()) %>%
    filter(data_type == "modeled locations, estimated number of farms") 
  
  count_red  <- count_red_df$n
  
if(is_empty(count_red) == TRUE){
    count_red = 0
  }
    
    
  
## create first plot
total_map <- ggplot(data = world) +
  geom_sf(fill = "white", lwd = 0.1) + 
  geom_point(data = all_farms_i, aes(x = X, y = Y, col = data_type), size = 0.1, alpha = 0.7) +
  coord_sf(xlim = c(-180, 180), ylim = c(-58, 73), expand = FALSE) +
  scale_x_continuous(breaks = c(-180, -135, -90, -45, 0, 45, 90, 135, 180), position = "top") +
  scale_y_continuous(breaks = c(-90, -45, 0, 45, 90)) + 
  theme_bw() + 
  theme(axis.title.x = element_blank(),
          axis.title.y = element_blank(),
        legend.position = "bottom", 
        legend.title=element_blank(),
        text=element_text(family="Times New Roman"), 
        legend.justification='left',
        legend.direction='horizontal') +
  guides(color = guide_legend(override.aes = list(size = 3, alpha = 0.9) )) +
  scale_color_manual(values = c("forestgreen", "orange1", "red3"),
                    breaks = c("known locations", "modeled locations, known number of farms", "modeled locations, estimated number of farms"), labels = c(sprintf("Known locations \n N = %s", count_green), sprintf("Modeled locations, known number of farms \n N = %s", count_yellow), sprintf("Modeled locations, estimated number of farms \n N = %s", count_red)), drop = FALSE) +
  labs(caption = sprintf("Data type %s: N = %s", data_type_2_id, count_type))
  


# total_map


# Create marginal plots
# Use geom_density/histogram for whatever you plotted on x/y axis 
plot_x <- axis_canvas(total_map, axis = "x") +
  geom_histogram(data = all_farms_i, aes(X, fill = data_type), bins = 360)  +
  #  geom_vline(xintercept = 135) + # check to make sure it lines up
  coord_sf(xlim = c(-180, 180), expand = FALSE) +
  scale_fill_manual(values = c("forestgreen", "orange1", "red3"), 
                    breaks = c("known locations", "modeled locations, known number of farms", "modeled locations, estimated number of farms"), drop = FALSE)
plot_x

plot_y <- axis_canvas(total_map, axis = "y") +
  geom_histogram(data = all_farms_i, aes(y = Y, fill = data_type), bins = 180, orientation = "y") +
 #  geom_hline(yintercept = 0) + #  check to make sure it lines up
  coord_sf(ylim = c(-58, 73), expand = FALSE) + 
  scale_fill_manual(values = c("forestgreen", "orange1", "red3"), 
                    breaks = c("known locations", "modeled locations, known number of farms", "modeled locations, estimated number of farms"), drop = FALSE)
 # coord_flip() 
plot_y

# Combine all plots into one
plot_final <- insert_xaxis_grob(total_map, plot_x, position = "top")
plot_final <- insert_yaxis_grob(plot_final, plot_y, position = "right") 
ggdraw(plot_final)

ggsave(sprintf("analysis/si_figs/supp_map_fig_%s.jpg", data_type_2_id))

}

```


## Make maps for diagram 

First map: 
 - All data type A, and known locations from data type C and D
 
 Second map: 
 - Unknown locations from B, C, D, E, & F
    - All F
    - All E
    - All B
    - Unknown C
    - Unknown D
    

**First diagram map**
```{r}
  
  all_farms_i <- all_farms %>%
    filter(data_type_2 %in% c("A", "C", "D")) %>%
  filter(data_type == "known locations")
  
  
    count_green_df <- all_farms_i %>%
    group_by(data_type) %>%
    summarise(n = n()) %>%
    filter(data_type == "known locations")
  
  count_green <- count_green_df$n
  
    
if(is_empty(count_green) == TRUE){
    count_green = 0
  }
    
  count_yellow_df <-  all_farms_i %>%
    group_by(data_type) %>%
    summarise(n = n()) %>%
    filter(data_type == "modeled locations, known number of farms")
  
  count_yellow <- count_yellow_df$n
  
    
if(is_empty(count_yellow) == TRUE){
    count_yellow = 0
  }
    
    
  count_red_df <- all_farms_i %>%
    group_by(data_type) %>%
    summarise(n = n()) %>%
    filter(data_type == "modeled locations, estimated number of farms") 
  
  count_red  <- count_red_df$n
  
if(is_empty(count_red) == TRUE){
    count_red = 0
  }
    
    
  
## create first plot
total_map <- ggplot(data = world) +
  geom_sf(fill = "white", lwd = 0.1) + 
  geom_point(data = all_farms_i, aes(x = X, y = Y, col = data_type), size = 0.1, alpha = 0.7) +
  coord_sf(xlim = c(-180, 180), ylim = c(-58, 73), expand = FALSE) +
  scale_x_continuous(breaks = c(-180, -135, -90, -45, 0, 45, 90, 135, 180), position = "top") +
  scale_y_continuous(breaks = c(-90, -45, 0, 45, 90)) + 
  theme_bw() + 
  theme(axis.title.x = element_blank(),
          axis.title.y = element_blank(),
        legend.position = "bottom", 
        legend.title=element_blank(),
        text=element_text(family="Times New Roman"),
        legend.justification='left',
        legend.direction='horizontal') +
  guides(color = guide_legend(override.aes = list(size = 3, alpha = 0.9))) +
  scale_color_manual(values = c("forestgreen", "orange1", "red3"),
                    breaks = c("known locations", "modeled locations, known number of farms", "modeled locations, estimated number of farms"), labels = c(sprintf("Known locations \n N = %s", count_green), sprintf("Modeled locations, known number of farms \n N = %s", count_yellow), sprintf("Modeled locations, estimated number of farms \n N = %s", count_red)), drop = FALSE)
  


total_map


# Create marginal plots
# Use geom_density/histogram for whatever you plotted on x/y axis 
plot_x <- axis_canvas(total_map, axis = "x") +
  geom_histogram(data = all_farms_i, aes(X, fill = data_type), bins = 360)  +
  #  geom_vline(xintercept = 135) + # check to make sure it lines up
  coord_sf(xlim = c(-180, 180), expand = FALSE) +
  scale_fill_manual(values = c("forestgreen", "orange1", "red3"), 
                    breaks = c("known locations", "modeled locations, known number of farms", "modeled locations, estimated number of farms"), drop = FALSE)


plot_y <- axis_canvas(total_map, axis = "y") +
  geom_histogram(data = all_farms_i, aes(y = Y, fill = data_type), bins = 180, orientation = "y") +
 #  geom_hline(yintercept = 0) + #  check to make sure it lines up
  coord_sf(ylim = c(-58, 73), expand = FALSE) + 
  scale_fill_manual(values = c("forestgreen", "orange1", "red3"), 
                    breaks = c("known locations", "modeled locations, known number of farms", "modeled locations, estimated number of farms"), drop = FALSE)
 # coord_flip() 


# Combine all plots into one
plot_final <- insert_xaxis_grob(total_map, plot_x, position = "top")
plot_final <- insert_yaxis_grob(plot_final, plot_y, position = "right") 
ggdraw(plot_final)

ggsave("analysis/si_figs/workflow_fig_1.jpg")

```

**Second diagram map**
```{r}
  
  all_farms_i <- all_farms %>%
    filter(data_type_2 %in% c("B", "C", "D", "E", "F")) %>%
  filter(data_type != "known locations")
  
  
    count_green_df <- all_farms_i %>%
    group_by(data_type) %>%
    summarise(n = n()) %>%
    filter(data_type == "known locations")
  
  count_green <- count_green_df$n
  
    
if(is_empty(count_green) == TRUE){
    count_green = 0
  }
    
  count_yellow_df <-  all_farms_i %>%
    group_by(data_type) %>%
    summarise(n = n()) %>%
    filter(data_type == "modeled locations, known number of farms")
  
  count_yellow <- count_yellow_df$n
  
    
if(is_empty(count_yellow) == TRUE){
    count_yellow = 0
  }
    
    
  count_red_df <- all_farms_i %>%
    group_by(data_type) %>%
    summarise(n = n()) %>%
    filter(data_type == "modeled locations, estimated number of farms") 
  
  count_red  <- count_red_df$n
  
if(is_empty(count_red) == TRUE){
    count_red = 0
  }
    
    
  
## create first plot
total_map <- ggplot(data = world) +
  geom_sf(fill = "white", lwd = 0.1) + 
  geom_point(data = all_farms_i, aes(x = X, y = Y, col = data_type), size = 0.1, alpha = 0.7) +
  coord_sf(xlim = c(-180, 180), ylim = c(-58, 73), expand = FALSE) +
  scale_x_continuous(breaks = c(-180, -135, -90, -45, 0, 45, 90, 135, 180), position = "top") +
  scale_y_continuous(breaks = c(-90, -45, 0, 45, 90)) + 
  theme_bw() + 
  theme(axis.title.x = element_blank(),
          axis.title.y = element_blank(),
        legend.position = "bottom", 
        legend.title=element_blank(),
        text=element_text(family="Times New Roman"),
        legend.justification='left',
        legend.direction='horizontal') +
  guides(color = guide_legend(override.aes = list(size = 3, alpha = 0.9))) +
  scale_color_manual(values = c("forestgreen", "orange1", "red3"),
                    breaks = c("known locations", "modeled locations, known number of farms", "modeled locations, estimated number of farms"), labels = c(sprintf("Known locations \n N = %s", count_green), sprintf("Modeled locations, known number of farms \n N = %s", count_yellow), sprintf("Modeled locations, estimated number of farms \n N = %s", count_red)), drop = FALSE)
  


total_map


# Create marginal plots
# Use geom_density/histogram for whatever you plotted on x/y axis 
plot_x <- axis_canvas(total_map, axis = "x") +
  geom_histogram(data = all_farms_i, aes(X, fill = data_type), bins = 360)  +
  #  geom_vline(xintercept = 135) + # check to make sure it lines up
  coord_sf(xlim = c(-180, 180), expand = FALSE) +
  scale_fill_manual(values = c("forestgreen", "orange1", "red3"), 
                    breaks = c("known locations", "modeled locations, known number of farms", "modeled locations, estimated number of farms"), drop = FALSE)


plot_y <- axis_canvas(total_map, axis = "y") +
  geom_histogram(data = all_farms_i, aes(y = Y, fill = data_type), bins = 180, orientation = "y") +
 #  geom_hline(yintercept = 0) + #  check to make sure it lines up
  coord_sf(ylim = c(-58, 73), expand = FALSE) + 
  scale_fill_manual(values = c("forestgreen", "orange1", "red3"), 
                    breaks = c("known locations", "modeled locations, known number of farms", "modeled locations, estimated number of farms"), drop = FALSE)
 # coord_flip() 


# Combine all plots into one
plot_final <- insert_xaxis_grob(total_map, plot_x, position = "top")
plot_final <- insert_yaxis_grob(plot_final, plot_y, position = "right") 
ggdraw(plot_final)

ggsave("analysis/si_figs/workflow_fig_2.jpg")

```
