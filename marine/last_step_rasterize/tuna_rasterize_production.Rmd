---
title: "Rasterizing prodution per each region"
author: "Gage Clawson (NCEAS, UCSB, OHI)"
date: "12/14/2020"
output: html_document
editor_options: 
  chunk_output_type: console
---



```{r}

library(here)
library(dplyr)
library(sf)
library(raster)
library(mapview)

source(here::here("_spatial/template_raster.R"))
source(here::here('workflow/common.R'))

```


# Global regions

```{r}

# this file includes ocean regions:
gadm <- raster("/home/shares/food-systems/Food_footprint/_raw_data/Country_regions/gadm36mol_pyfill_10km.tif")

gadm_latlon <- raster::projectRaster(gadm, food_raster, method="ngb", over=TRUE)

gadm_codes <- read.csv("/home/shares/food-systems/Food_footprint/_raw_data/Country_regions/gadm_reg_codes.csv") %>% 
  mutate(reg_id = as.numeric(reg_id))

```

# read in points and converted to spatial dataframe
```{r}

# all_farms <- readRDS("data/all_modeled_marine_farms_final.rds")

all_farms <- read_csv("data/all_marine_aquaculture_farms_sources_final.csv") %>%
      st_as_sf(., 
           coords = c("X", "Y"),
           crs = crs(food_raster), 
           agr = "constant")  

tuna_farms <- all_farms %>%
  dplyr::filter(species_group == "Bluefin tuna")

mapview(tuna_farms)
```


# determine subregions where points are located

```{r}

tuna_farms$reg_id <- raster::extract(gadm_latlon, tuna_farms) 

farms_sf <- tuna_farms %>%
  left_join(gadm_codes, by="reg_id") %>%
  dplyr::mutate(NAME_1 = as.character(NAME_1))

farms_sf$check <-  paste(farms_sf$iso3c, farms_sf$GID_0, sep=":")
table(farms_sf$check)

## no mismatches
```


# FAO tuna production data per country
```{r}

fao <- read.csv(here::here("marine/tuna/tuna_farms/data/fao_mariculture_tuna.csv")) %>%
  dplyr::filter(year == 2017) %>%
  dplyr::select(iso3c, fao_tonnes_production)

setdiff(fao$iso3c, farms_sf$iso3c)
setdiff(farms_sf$iso3c, fao$iso3c)

```


# join country production to farms by iso3c

```{r}

farms_sf_correct <- farms_sf %>%
  left_join(fao, by="iso3c")

summary(farms_sf_correct) # make sure no production NA values

```


# get areas with no regional production data and calculate production per farm

```{r}

## calculate farm production
farms_prod <- farms_sf_correct %>%
  group_by(NAME_0) %>%
  add_tally() %>%
  ungroup() %>%
  # mutate(tonnes_per_farm = fao_tonnes_production/n) %>%
  dplyr::select(iso3c, tonnes_per_farm, geometry) 

```

# combine and check it all matches ok

```{r}

farm_production <- farms_prod

test <- farm_production %>%
  st_drop_geometry() %>%
  dplyr::group_by(iso3c) %>%
  dplyr::summarize(total_tonnes = sum(tonnes_per_farm, na.rm=TRUE)) %>%
  left_join(fao, by = "iso3c") %>%
  mutate(difference = fao_tonnes_production - total_tonnes)


farms_sf_prod <- st_as_sf(farm_production)
mapview(farms_sf_prod, cex = "tonnes_per_farm")

## write the production data so that we can use it for the nutrient layer. 
st_write(farms_sf_prod, "/home/shares/food-systems/Food_footprint/all_food_systems/dataprep/aquaculture/marine/tuna/updated/prod_data_by_cell_iso3c.shp", delete_dsn = TRUE)

```

## convert to raster, with the value of each cell equalling the sum tonnes per farm for all farms landing in cell.

```{r}

farms_sf <- st_as_sf(farm_production)
mapview(farms_sf)

sum(farms_sf$tonnes_per_farm) # 37072.56

tuna_raster_check <- rasterize(farms_sf, food_raster, field = "tonnes_per_farm", fun=sum)
plot(log(tuna_raster_check+1))
# s <- raster::select(tuna_raster_check)
# plot(s)

cellStats(tuna_raster_check, stat = "sum", na.rm = TRUE) # 37072.56

mapview(tuna_raster_check)

tuna_raster <- rasterize(farms_sf, food_raster, field = "tonnes_per_farm", fun=sum, background=0)
mapview(log(tuna_raster+1)) 

plot(log(tuna_raster+1))

tuna_raster_df <- as.data.frame(tuna_raster, xy=TRUE) %>%
  dplyr::select(x,y, tonnes_production=layer)

cellStats(tuna_raster, stat = "sum") # 37072.56
sum(tuna_raster_df$tonnes_production) # 37072.56
sum(farms_sf$tonnes_per_farm, na.rm = TRUE) # 37072.56
sum(fao$fao_tonnes_production) # 37072.56

write_csv(tuna_raster_df, "/home/shares/food-systems/Food_footprint/all_food_systems/dataprep/aquaculture/marine/tuna/updated/tuna_farm_updated.csv")

writeRaster(tuna_raster, "/home/shares/food-systems/Food_footprint/all_food_systems/dataprep/aquaculture/marine/production/rasters/tuna_production_rast.tif")

```
